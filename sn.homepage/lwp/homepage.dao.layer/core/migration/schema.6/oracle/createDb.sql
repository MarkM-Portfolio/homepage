-- ***************************************************************** 
--                                                                   
-- IBM Confidential                                                  
--                                                                   
-- OCO Source Materials                                              
--                                                                   
-- Copyright IBM Corp. 2008, 2015                                    
--                                                                   
-- The source code for this program is not published or otherwise    
-- divested of its trade secrets, irrespective of what has been      
-- deposited with the U.S. Copyright Office.                         
--                                                                   
-- ***************************************************************** 

-- DB2   	ORACLE
-- CHAR 	-> CHAR
-- VARCHAR	-> VARCHAR2
-- SMALLINT	-> NUMBER(5,0) 
-- INTEGER	-> NUMBER(10 ,0)
-- BIGINT	-> NUMBER(19 ,0)
-- CLOB(max)	-> CLOB
-- BLOB(max)	-> BLOB
-- TIMESTAMP	-> TIMESTAMP

--------------------------------------
-- CREATE THE TABLESPACE
--------------------------------------
CREATE SMALLFILE TABLESPACE "HOMEPAGEREGTABSPACE" DATAFILE 'HOMEPAGEREGTABSPACE' SIZE 800M REUSE AUTOEXTEND ON NEXT 200M MAXSIZE UNLIMITED LOGGING EXTENT MANAGEMENT LOCAL SEGMENT SPACE MANAGEMENT AUTO;
CREATE SMALLFILE TABLESPACE "HOMEPAGEINDEXTABSPACE" DATAFILE 'HOMEPAGEINDEXTABSPACE' SIZE 800M REUSE AUTOEXTEND ON NEXT 200M MAXSIZE UNLIMITED LOGGING EXTENT MANAGEMENT LOCAL SEGMENT SPACE MANAGEMENT AUTO; 

--------------------------------------
-- CREATE THE USER\SCHEMA
--------------------------------------
CREATE USER "HOMEPAGE" PROFILE "DEFAULT" IDENTIFIED BY "&1" DEFAULT TABLESPACE "HOMEPAGEREGTABSPACE" TEMPORARY TABLESPACE "TEMP" ACCOUNT UNLOCK;
COMMIT;

-------------------------------------
-- ALTER HOMEPAGE USER, assumes already created
-------------------------------------
GRANT "CONNECT" TO "HOMEPAGE";
ALTER USER "HOMEPAGE" DEFAULT ROLE ALL;
GRANT ALTER TABLESPACE TO "HOMEPAGE";
GRANT UNLIMITED TABLESPACE TO "HOMEPAGE";

--------------------------------------
-- CREATE THE TABLES
--------------------------------------
CREATE TABLE "HOMEPAGE"."HOMEPAGE_SCHEMA" ( 
	"COMPKEY" VARCHAR2(36) NOT NULL,
	"DBSCHEMAVER" NUMBER(10, 0) NOT NULL
) 
TABLESPACE "HOMEPAGEREGTABSPACE";

CREATE TABLE "HOMEPAGE"."PERSON"  (
	PERSON_ID VARCHAR2(36) NOT NULL,
	DISPLAYNAME VARCHAR2(256) NOT NULL,
	EXID VARCHAR2(256) NOT NULL,
	USER_MAIL VARCHAR2(256),
	LAST_VISIT TIMESTAMP NOT NULL,
	WELCOME_MODE NUMBER(1) DEFAULT 1 NOT NULL,
	SHOW_DISABLED_WIDGETS NUMBER(1) DEFAULT 0 NOT NULL
)
TABLESPACE "HOMEPAGEREGTABSPACE";

CREATE TABLE "HOMEPAGE"."LOGINNAME" (
	PERSON_ID VARCHAR2(36) NOT NULL,
	LOGINNAME VARCHAR2(256) NOT NULL
)
TABLESPACE "HOMEPAGEREGTABSPACE"; 

CREATE TABLE "HOMEPAGE"."USER_WIDGET_PREF"  (
	USER_WIDGET_PREF_ID VARCHAR2(36) NOT NULL,
	USER_ID VARCHAR2(36) NOT NULL,
	WIDGET_ID VARCHAR2(36) NOT NULL,
	PAGE_ID VARCHAR2(36),
	WIDGET_SETTING VARCHAR2(2048),
	MAX_MIN NUMBER(1),
	ROW_NUM NUMBER(10,0),
	COL_NUM NUMBER(10,0)
)
TABLESPACE "HOMEPAGEREGTABSPACE";

CREATE TABLE "HOMEPAGE"."WIDGET" (
	WIDGET_ID VARCHAR2(36) NOT NULL,
	WIDGET_TITLE VARCHAR2(256) NOT NULL,
	WIDGET_TEXT VARCHAR2(256),
	WIDGET_URL VARCHAR2(256) NOT NULL,
	WIDGET_ICON VARCHAR2(256),
	WIDGET_ENABLED NUMBER(1) DEFAULT 0 NOT NULL,
	WIDGET_SYSTEM NUMBER(1) DEFAULT 0 NOT NULL,
	WIDGET_HOMEPAGE_SPECIFIC NUMBER(1) DEFAULT 0 NOT NULL
)
TABLESPACE "HOMEPAGEREGTABSPACE";

CREATE TABLE "HOMEPAGE"."PREREQ" (
	PREREQ_ID VARCHAR2(36) NOT NULL,
	APP_ID VARCHAR2(36) NOT NULL,
	WIDGET_ID VARCHAR2(36) NOT NULL
)
TABLESPACE "HOMEPAGEREGTABSPACE";	

--------------------------------------
-- CREATE THE CONSTRAINTS
--------------------------------------

ALTER TABLE "HOMEPAGE"."PERSON" 
    ADD (CONSTRAINT "PK_PERSON_ID" PRIMARY KEY ("PERSON_ID")
    USING INDEX TABLESPACE "HOMEPAGEINDEXTABSPACE");

ALTER TABLE "HOMEPAGE"."USER_WIDGET_PREF"
    ADD (CONSTRAINT "PK_USER_FP_ID" PRIMARY KEY ("USER_WIDGET_PREF_ID")
    USING INDEX TABLESPACE "HOMEPAGEINDEXTABSPACE");

ALTER TABLE "HOMEPAGE"."WIDGET"
	ADD (CONSTRAINT "PK_WIDGET" PRIMARY KEY ("WIDGET_ID")
    USING INDEX TABLESPACE "HOMEPAGEINDEXTABSPACE");

ALTER TABLE "HOMEPAGE"."PREREQ" 
	ADD (CONSTRAINT "PK_PREREQ" PRIMARY KEY ("PREREQ_ID")
    USING INDEX TABLESPACE "HOMEPAGEINDEXTABSPACE");

ALTER TABLE "HOMEPAGE"."LOGINNAME"
	ADD CONSTRAINT "PK_LOGINNAME_ID" PRIMARY KEY ("PERSON_ID","LOGINNAME")
    USING INDEX TABLESPACE "HOMEPAGEINDEXTABSPACE";

ALTER TABLE "HOMEPAGE"."LOGINNAME"
	ADD CONSTRAINT "FK_PERSON_ID" FOREIGN KEY ("PERSON_ID")
	REFERENCES "HOMEPAGE"."PERSON" ("PERSON_ID");

ALTER TABLE "HOMEPAGE"."USER_WIDGET_PREF"
    ADD CONSTRAINT "FK_USER_ID" FOREIGN KEY ("USER_ID")
	REFERENCES HOMEPAGE.PERSON("PERSON_ID");

ALTER TABLE "HOMEPAGE"."USER_WIDGET_PREF" 
	ADD CONSTRAINT "FK_WIDGET_ID" FOREIGN KEY ("WIDGET_ID")
	REFERENCES HOMEPAGE.WIDGET ("WIDGET_ID");
	
ALTER TABLE "HOMEPAGE"."PREREQ"
	ADD CONSTRAINT "FK_PREREQ_WIDGET" FOREIGN KEY ("WIDGET_ID")
	REFERENCES HOMEPAGE.WIDGET("WIDGET_ID")
	ON DELETE CASCADE;
	
ALTER TABLE "HOMEPAGE"."LOGINNAME"
	ADD CONSTRAINT LOGINNAME_UNIQUE UNIQUE(LOGINNAME);
	
--------------------------------------
-- CREATE THE INDEXES
--------------------------------------

CREATE UNIQUE INDEX "HOMEPAGE"."USERID_WIDGET_UNIQUE" 
	ON "HOMEPAGE"."USER_WIDGET_PREF"("USER_ID" ASC, "WIDGET_ID" ASC);
	
CREATE UNIQUE INDEX "HOMEPAGE"."PERSON_EXID"
    ON "HOMEPAGE"."PERSON"("EXID");
    
CREATE INDEX "HOMEPAGE"."PERSON_USER_MAIL"
	ON "HOMEPAGE"."PERSON"("USER_MAIL");
--------------------------------------
-- CREATE THE VIEWS
--------------------------------------

-- TBD

--------------------------------------
-- POPULATE THE TABLES
--------------------------------------

INSERT INTO "HOMEPAGE"."HOMEPAGE_SCHEMA"
	( "COMPKEY", "DBSCHEMAVER") 
VALUES 
	( 'HOMEPAGE', 6);


--------------------------------------
-- ENABLE ROW MOVEMENT (for backup, epxort/import)
--------------------------------------
ALTER TABLE "HOMEPAGE"."HOMEPAGE_SCHEMA" ENABLE ROW MOVEMENT;
ALTER TABLE "HOMEPAGE"."PERSON" 
ALTER TABLE "HOMEPAGE"."USER_WIDGET_PREF"
ALTER TABLE "HOMEPAGE"."WIDGET"
ALTER TABLE "HOMEPAGE"."PREREQ"
ALTER TABLE "HOMEPAGE"."LOGINNAME"

COMMIT;

--------------------------------------
-- DISCONNECT
--------------------------------------
DISCONNECT ALL;

QUIT;
