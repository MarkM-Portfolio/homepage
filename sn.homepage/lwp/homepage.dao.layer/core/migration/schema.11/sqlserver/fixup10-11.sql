-- ***************************************************************** 
--                                                                   
-- IBM Confidential                                                  
--                                                                   
-- OCO Source Materials                                              
--                                                                   
-- Copyright IBM Corp. 2008, 2015                                    
--                                                                   
-- The source code for this program is not published or otherwise    
-- divested of its trade secrets, irrespective of what has been      
-- deposited with the U.S. Copyright Office.                         
--                                                                   
-- ***************************************************************** 

USE HOMEPAGE;
GO

BEGIN TRANSACTION
GO


----------------------------------------------------
-- 1) START ADDING INDEXES FOR HOMEPAGE TABLES
----------------------------------------------------
CREATE INDEX TAB_INST_UI_ID_IDX 
	ON HOMEPAGE.HP_TAB_INST(UI_ID)
GO


CREATE INDEX HP_WIDGET_INST_TAB_INST_ID_IDX
	ON HOMEPAGE.HP_WIDGET_INST(TAB_INST_ID)
GO

----------------------------------------------------
-- END ADDING INDEXES FOR HOMEPAGE TABLES
----------------------------------------------------

-------------------------------------------------------------------
-- 2) START ADDING NEW TABLES FOR NEWS REPOSITORY AND EMAIL DIGEST
-------------------------------------------------------------------

-- NEW REPOSITORY
CREATE TABLE HOMEPAGE.NR_EVENT_RECORDS  (
	EVENT_RECORD_ID nvarchar(36) NOT NULL,
	EVENT_RECORD_CONTENT varbinary (MAX),
	IS_ACL NUMERIC(5,0) NOT NULL
) ON [PRIMARY]
GO

-- EMAIL DIGEST
CREATE TABLE HOMEPAGE.EMD_RECIPIENTS (
	RECIPIENT_ID nvarchar(36) NOT NULL,
	PERSON_ID nvarchar(36) NOT NULL,
	FREQUENCY_UPDATE NUMERIC(5,0) NOT NULL,
	LAST_SENT_UPDATE DATETIME NOT NULL,
	MAIL_DOMAIN nvarchar(256) NOT NULL,
	MAIL_ADDRESS  nvarchar(256) NOT NULL
) ON [PRIMARY]
GO

CREATE TABLE HOMEPAGE.EMD_JOBS  (
	JOB_ID nvarchar(36) NOT NULL,
	JOB_FREQUENCY NUMERIC(5,0) NOT NULL,
	NEXT_EXEC_TIME DATETIME NOT NULL,
	DUE_DATE_EXEC_TIME DATETIME,
	START_JOB DATETIME,
	END_JOB DATETIME,
	STATUS nvarchar(36),
	N_PERSONS_TO_UPDATE NUMERIC(10,0),
	AVG_EXEC_JOB NUMERIC(10,0)
) ON [PRIMARY]
GO

CREATE TABLE HOMEPAGE.EMD_JOBS_STATS (
	STAT_ID nvarchar(36) NOT NULL,
	JOB_ID nvarchar(36) NOT NULL,
	START_TIME DATETIME NOT NULL,
    END_TIME DATETIME NOT NULL,
    EXEC_TIME NUMERIC(10,0),
    N_PERSONS_UPDATED NUMERIC(10,0)
) ON [PRIMARY]
GO


-- NEWS REPOSITORY CONSTRAINTS
ALTER TABLE HOMEPAGE.NR_EVENT_RECORDS
    ADD CONSTRAINT PK_EVENT_RECORD_ID PRIMARY KEY(EVENT_RECORD_ID)
GO 

-- EMAIL DIGEST CONSTRAINTS
ALTER TABLE HOMEPAGE.EMD_RECIPIENTS
    ADD CONSTRAINT PK_RECIPIENT_ID PRIMARY KEY(RECIPIENT_ID)
GO    

ALTER TABLE HOMEPAGE.EMD_JOBS
    ADD CONSTRAINT PK_JOB_ID PRIMARY KEY(JOB_ID)
GO

ALTER TABLE HOMEPAGE.EMD_JOBS_STATS
    ADD CONSTRAINT PK_STAT_ID PRIMARY KEY(STAT_ID)
GO

ALTER TABLE HOMEPAGE.EMD_RECIPIENTS
    ADD CONSTRAINT FK_REC_PERSON_ID FOREIGN KEY (PERSON_ID)
	REFERENCES HOMEPAGE.PERSON (PERSON_ID)
GO
	
ALTER TABLE HOMEPAGE.EMD_JOBS_STATS
    ADD CONSTRAINT FK_JOB_ID FOREIGN KEY (JOB_ID)
	REFERENCES HOMEPAGE.EMD_JOBS (JOB_ID)
GO

ALTER TABLE HOMEPAGE.EMD_JOBS
	ADD CONSTRAINT UNIQUE_JOB_FREQ UNIQUE(JOB_FREQUENCY)
GO

------------------------------------------------------------------
-- END ADDING NEW TABLES FOR NEWS REPOSITORY AND EMAIL DIGIEST
------------------------------------------------------------------

-------------------------------------------------------------------
-- 3) START ADDING INDEXES FOR NEWS REPOSITORY AND EMAIL DIGIEST
-------------------------------------------------------------------

-- NEW REPOSITORY INDEXES
CREATE INDEX NR_NEWS_RECORDS_READER_IDX
	ON HOMEPAGE.NR_NEWS_RECORDS(READER_ID)
GO	

CREATE INDEX NR_NEWS_RECORDS_ACTOR_IDX
	ON HOMEPAGE.NR_NEWS_RECORDS(ACTOR_UUID)
GO	

CREATE INDEX NR_NEWS_RECORDS_SOURCE_IDX
	ON HOMEPAGE.NR_NEWS_RECORDS(SOURCE)
GO	

CREATE INDEX NR_NEWS_RECORDS_CONTAINER_IDX
	ON HOMEPAGE.NR_NEWS_RECORDS(CONTAINER_ID)
GO
	
CREATE INDEX NR_NEWS_RECORDS_DATE_IDX
	ON HOMEPAGE.NR_NEWS_RECORDS(CREATION_DATE DESC)
GO

CREATE INDEX NR_NEWS_RECORDS_EVENT_IDX
	ON HOMEPAGE.NR_NEWS_RECORDS(EVENT_RECORD_UUID)	
GO
	
-- EMAIL DIGEST INDEXES
CREATE INDEX EMD_RECIPIENTS_SENT_UPDATE_IDX
	ON HOMEPAGE.EMD_RECIPIENTS(LAST_SENT_UPDATE DESC)
GO	

CREATE INDEX EMD_RECIPIENTS_MAIL_DOMAIN_IDX
	ON HOMEPAGE.EMD_RECIPIENTS(MAIL_DOMAIN DESC)
GO
	
-------------------------------------------------------------------
-- END ADDING INDEXES FOR NEWS REPOSITORY AND EMAIL DIGIEST
-------------------------------------------------------------------

-------------------------------------------------------------------
-- 4) START ADDING SCHEDULER TABLES
-------------------------------------------------------------------

CREATE TABLE HOMEPAGE.NR_SCHEDULER_TASK (
	[TASKID] BIGINT NOT NULL ,
	[VERSION] NVARCHAR(5) NOT NULL ,
	[ROW_VERSION] INT NOT NULL ,
	[TASKTYPE] INT NOT NULL ,
	[TASKSUSPENDED] TINYINT NOT NULL ,
	[CANCELLED] TINYINT NOT NULL ,
	[NEXTFIRETIME] BIGINT NOT NULL ,
	[STARTBYINTERVAL] NVARCHAR(254) NULL ,
	[STARTBYTIME] BIGINT NULL ,
	[VALIDFROMTIME] BIGINT NULL ,
    [VALIDTOTIME] BIGINT NULL ,
    [REPEATINTERVAL] NVARCHAR(254) NULL ,
    [MAXREPEATS] INT NOT NULL ,
    [REPEATSLEFT] INT NOT NULL ,
    [TASKINFO] IMAGE NULL ,
    [NAME] NVARCHAR(254) NOT NULL ,
    [AUTOPURGE] INT NOT NULL ,
    [FAILUREACTION] INT NULL ,
    [MAXATTEMPTS] INT NULL ,
    [QOS] INT NULL ,
    [PARTITIONID] INT NULL ,
    [OWNERTOKEN] NVARCHAR(200) NOT NULL ,
    [CREATETIME] BIGINT NOT NULL
) 
GO

ALTER TABLE HOMEPAGE.NR_SCHEDULER_TASK WITH NOCHECK 
	ADD CONSTRAINT NR_SCHEDULER_TASK_PK PRIMARY KEY  NONCLUSTERED ( [TASKID] ) 
GO

CREATE INDEX NR_SCHEDULER_TASK_IDX1 
	ON HOMEPAGE.NR_SCHEDULER_TASK ( [TASKID], [OWNERTOKEN] ) 
GO

CREATE CLUSTERED INDEX NR_SCHEDULER_TASK_IDX2 
	ON HOMEPAGE.NR_SCHEDULER_TASK ( [NEXTFIRETIME] ASC, [REPEATSLEFT], [PARTITIONID] )
GO

CREATE TABLE HOMEPAGE.NR_SCHEDULER_TREG ( 
	[REGKEY] NVARCHAR(254) NOT NULL ,
	[REGVALUE] NVARCHAR(254) NULL ,
	PRIMARY KEY ( [REGKEY] ) )
GO

CREATE TABLE HOMEPAGE.NR_SCHEDULER_LMGR ( 
	[LEASENAME] NVARCHAR(254) NOT NULL,
	[LEASEOWNER] NVARCHAR(254) NOT NULL,
	[LEASE_EXPIRE_TIME] BIGINT,
	[DISABLED] NVARCHAR(5) )
GO

ALTER TABLE HOMEPAGE.NR_SCHEDULER_LMGR WITH NOCHECK 
	ADD CONSTRAINT NR_SCHEDULER_LMGR_PK PRIMARY KEY  NONCLUSTERED ( [LEASENAME] ) 
GO

CREATE TABLE HOMEPAGE.NR_SCHEDULER_LMPR ( 
	[LEASENAME] NVARCHAR(224) NOT NULL,
	[NAME] NVARCHAR(224) NOT NULL,
    [VALUE] NVARCHAR(254) NOT NULL )
GO

CREATE INDEX NR_SCHEDULER_LMPR_IDX1 
	ON HOMEPAGE.NR_SCHEDULER_LMPR ( [LEASENAME], [NAME] ) 
GO
	
-------------------------------------------------------------------
-- END ADDING SCHEDULER TABLES
-------------------------------------------------------------------

-------------------------------------------------------------------
-- 5) START GRANT THE LCUSER
-------------------------------------------------------------------

-- News Repository
GRANT DELETE,INSERT,SELECT,UPDATE ON HOMEPAGE.NR_EVENT_RECORDS TO  HOMEPAGEUSER
GO

-- Email digest
GRANT DELETE,INSERT,SELECT,UPDATE ON HOMEPAGE.EMD_RECIPIENTS TO  HOMEPAGEUSER
GO

GRANT DELETE,INSERT,SELECT,UPDATE ON HOMEPAGE.EMD_JOBS TO  HOMEPAGEUSER
GO

GRANT DELETE,INSERT,SELECT,UPDATE ON HOMEPAGE.EMD_JOBS_STATS TO  HOMEPAGEUSER
GO

-- Scheduler
GRANT DELETE,INSERT,SELECT,UPDATE ON HOMEPAGE.NR_SCHEDULER_TASK TO  HOMEPAGEUSER
GO

GRANT DELETE,INSERT,SELECT,UPDATE ON HOMEPAGE.NR_SCHEDULER_TREG TO  HOMEPAGEUSER
GO

GRANT DELETE,INSERT,SELECT,UPDATE ON HOMEPAGE.NR_SCHEDULER_LMGR TO  HOMEPAGEUSER
GO

GRANT DELETE,INSERT,SELECT,UPDATE ON HOMEPAGE.NR_SCHEDULER_LMPR TO  HOMEPAGEUSER
GO

-------------------------------------------------------------------
-- END GRANT THE LCUSER
-------------------------------------------------------------------

-- Updating the schema version from 10 to 11
UPDATE  HOMEPAGE.HOMEPAGE_SCHEMA SET DBSCHEMAVER = 11
WHERE   DBSCHEMAVER = 10
GO




COMMIT