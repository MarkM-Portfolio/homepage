-- ***************************************************************** 
--                                                                   
-- IBM Confidential                                                  
--                                                                   
-- OCO Source Materials                                              
--                                                                   
-- Copyright IBM Corp. 2007, 2015                                    
--                                                                   
-- The source code for this program is not published or otherwise    
-- divested of its trade secrets, irrespective of what has been      
-- deposited with the U.S. Copyright Office.                         
--                                                                   
-- ***************************************************************** 

-- {COPYRIGHT}
-----------------------------------------------------
-- 9 MIGRATION FOR NT_NOTIFICATION TABLES
-----------------------------------------------------

UPDATE HOMEPAGE.NT_NOTIFICATION_RECIPIENT SET IS_DELETED = 0;

-- create temp view
CREATE VIEW HOMEPAGE.TEMP_COUNT_RECIPIENT AS (
    select      NT_NOTIFICATION.NOTIFICATION_ID, COUNT(NT_NOTIFICATION_RECIPIENT.RECIPIENT_EXID) AS RECIPIENT_COUNT
    from        HOMEPAGE.NT_NOTIFICATION NT_NOTIFICATION, 
                HOMEPAGE.NT_NOTIFICATION_RECIPIENT NT_NOTIFICATION_RECIPIENT
    where       NT_NOTIFICATION.NOTIFICATION_ID = NT_NOTIFICATION_RECIPIENT.NOTIFICATION_ID
    group by    NT_NOTIFICATION.NOTIFICATION_ID
);


CREATE VIEW HOMEPAGE.TEMP_FIND_RECIPIENT AS (
    select NOTIFICATION_ID, MAX(RECIPIENT_EXID) RECIPIENT_EXID
    from HOMEPAGE.NT_NOTIFICATION_RECIPIENT  NT_NOTIFICATION_RECIPIENT
    GROUP BY NOTIFICATION_ID
);


-- create TEMP_NOTIFICATION table
CREATE TABLE HOMEPAGE.TEMP_NOTIFICATION (
	  NOTIFICATION_ID VARCHAR2(36) NOT NULL,
	  NOTIFICATION_SOURCE VARCHAR2(36) NOT NULL,
	  NOTIFICATION_TYPE VARCHAR2(256) NOT NULL,
	  DATETIME_STAMP TIMESTAMP NOT NULL,
	  SENDER_EXID VARCHAR2(36) NOT NULL,
	  SUBJECT VARCHAR2(256),
	  MESSAGE VARCHAR2(2048),
	  CONTAINER_NAME VARCHAR2(256),
	  CONTAINER_URL VARCHAR2(2048),
	  ITEM_NAME VARCHAR2(256),
	  ITEM_URL VARCHAR2(2048),
	  FIRST_RECIPIENT_EXID VARCHAR2(36),
	  NUM_RECIPIENTS NUMBER(5,0),
	  IS_DELETED NUMBER(5,0),
	  PRIMARY_ACTION_URL VARCHAR2(2048),
	  SECONDARY_ACTION_URL VARCHAR2(2048)	  
)
TABLESPACE "HPNTREGTABSPACE";

ALTER TABLE HOMEPAGE.TEMP_NOTIFICATION ENABLE ROW MOVEMENT;

-- copying temp the results to TEMP_NOTIFICATION
INSERT INTO HOMEPAGE.TEMP_NOTIFICATION (    NOTIFICATION_ID, NOTIFICATION_SOURCE, NOTIFICATION_TYPE, DATETIME_STAMP, SENDER_EXID, SUBJECT, MESSAGE, 
                                            CONTAINER_NAME, CONTAINER_URL, ITEM_NAME, ITEM_URL,
                                            FIRST_RECIPIENT_EXID, NUM_RECIPIENTS, IS_DELETED, PRIMARY_ACTION_URL, SECONDARY_ACTION_URL
                                        )    
SELECT  NT_NOTIFICATION.NOTIFICATION_ID, NOTIFICATION_SOURCE, NOTIFICATION_TYPE, DATETIME_STAMP, SENDER_EXID, SUBJECT, MESSAGE, 
        CONTAINER_NAME, CONTAINER_URL, ITEM_NAME, ITEM_URL, 
        TEMP_FIND_RECIPIENT.RECIPIENT_EXID , TEMP_COUNT_RECIPIENT.RECIPIENT_COUNT, 0, '',''
FROM    HOMEPAGE.NT_NOTIFICATION NT_NOTIFICATION, HOMEPAGE.TEMP_COUNT_RECIPIENT TEMP_COUNT_RECIPIENT, HOMEPAGE.TEMP_FIND_RECIPIENT TEMP_FIND_RECIPIENT
WHERE   NT_NOTIFICATION.NOTIFICATION_ID = TEMP_COUNT_RECIPIENT.NOTIFICATION_ID AND
        NT_NOTIFICATION.NOTIFICATION_ID = TEMP_FIND_RECIPIENT.NOTIFICATION_ID;

ALTER TABLE HOMEPAGE.NT_NOTIFICATION_RECIPIENT DROP CONSTRAINT "FK_RECIP_NOTIF";

DELETE FROM HOMEPAGE.NT_NOTIFICATION;

INSERT INTO HOMEPAGE.NT_NOTIFICATION (    	NOTIFICATION_ID, NOTIFICATION_SOURCE, NOTIFICATION_TYPE, DATETIME_STAMP, SENDER_EXID, SUBJECT, MESSAGE, 
                                            CONTAINER_NAME, CONTAINER_URL, ITEM_NAME, ITEM_URL,
                                            FIRST_RECIPIENT_EXID, NUM_RECIPIENTS, IS_DELETED, PRIMARY_ACTION_URL, SECONDARY_ACTION_URL
                                        )
SELECT  NOTIFICATION_ID, NOTIFICATION_SOURCE, NOTIFICATION_TYPE, DATETIME_STAMP, SENDER_EXID, SUBJECT, MESSAGE, 
        CONTAINER_NAME, CONTAINER_URL, ITEM_NAME, ITEM_URL, 
        FIRST_RECIPIENT_EXID, NUM_RECIPIENTS, IS_DELETED, PRIMARY_ACTION_URL, SECONDARY_ACTION_URL
FROM    HOMEPAGE.TEMP_NOTIFICATION;

ALTER TABLE HOMEPAGE.NT_NOTIFICATION_RECIPIENT 
	ADD CONSTRAINT "FK_RECIP_NOTIF" FOREIGN KEY ("NOTIFICATION_ID")
	REFERENCES HOMEPAGE.NT_NOTIFICATION ("NOTIFICATION_ID")
	ON DELETE CASCADE;

-- drop temps stuff
DROP TABLE HOMEPAGE.TEMP_NOTIFICATION;

DROP VIEW HOMEPAGE.TEMP_FIND_RECIPIENT;

DROP VIEW HOMEPAGE.TEMP_COUNT_RECIPIENT;