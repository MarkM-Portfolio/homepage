-- ***************************************************************** 
--                                                                   
-- IBM Confidential                                                  
--                                                                   
-- OCO Source Materials                                              
--                                                                   
-- Copyright IBM Corp. 2007, 2017                                    
--                                                                   
-- The source code for this program is not published or otherwise    
-- divested of its trade secrets, irrespective of what has been      
-- deposited with the U.S. Copyright Office.                         
--                                                                   
-- ***************************************************************** 

-- {COPYRIGHT}

----------------------------------------------------
------------------------ START HP FIXUP 451 --------
----------------------------------------------------

-- [Work Item 88850] New: Add constraint to MT_ORGANIZATION table for ORGANIZATION_EXID to be unique [o]
CREATE UNIQUE INDEX HOMEPAGE.UNQ_ORG_EXID
	ON HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_EXID) TABLESPACE "HPNTINDEXTABSPACE";

-- 87406: Rename MT_METRIC_STAT to METRIC_STAT
ALTER TABLE HOMEPAGE.MT_METRIC_STAT DROP CONSTRAINT PK_METRIC_STAT_ID;
--ALTER TABLE HOMEPAGE.MT_METRIC_STAT DROP CONSTRAINT FK_METRIC_STAT_ORG_ID;
declare
constraint_not_exists EXCEPTION;
PRAGMA EXCEPTION_INIT(constraint_not_exists, -2443);
begin
    execute immediate 'ALTER TABLE HOMEPAGE.MT_METRIC_STAT DROP CONSTRAINT FK_METRIC_STAT_ORG_ID';
exception
    when constraint_not_exists then null;
end;
/
DROP INDEX HOMEPAGE.MT_METRICS_IDX;

COMMIT;

ALTER TABLE HOMEPAGE.MT_METRIC_STAT 			RENAME TO METRIC_STAT;
ALTER TABLE HOMEPAGE.METRIC_STAT 				ENABLE ROW MOVEMENT;

COMMIT;

ALTER TABLE HOMEPAGE.METRIC_STAT 
    ADD (CONSTRAINT PK_METRIC_STAT_ID PRIMARY KEY(METRIC_STAT_ID) USING INDEX TABLESPACE "HPNTINDEXTABSPACE");

CREATE INDEX HOMEPAGE.METRIC_IDX
    ON HOMEPAGE.METRIC_STAT (RECORDED_ON ASC, METRIC_TYPE) TABLESPACE "HPNTINDEXTABSPACE";
    
ALTER TABLE HOMEPAGE.METRIC_STAT 
	ADD CONSTRAINT FK_METRIC_ORG_ID FOREIGN KEY (ORGANIZATION_ID) 
	REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);    

COMMIT;


-----------------------------------------------------
--  HOMEPAGE.MT_CFG_DEFINITIONS
-----------------------------------------------------
CREATE TABLE HOMEPAGE.MT_CFG_DEFINITIONS (
	DEFINITION_ID	VARCHAR2(36) NOT NULL,
	NAME			VARCHAR2(128) NOT NULL,
	TITLE			VARCHAR2(128),
	DESCRIPTION		VARCHAR2(256),
	TYPE			VARCHAR2(256),
	EDITOR			VARCHAR2(128),
	CAN_MODIFY		NUMBER(5,0) DEFAULT 0 NOT NULL,
	DISPLAY			NUMBER(5,0) DEFAULT 0 NOT NULL,
	REQUIRES		VARCHAR2(128),
	VALIDATOR		VARCHAR2(256),
	CATEGORY 		VARCHAR2(128)
)
TABLESPACE "HOMEPAGEREGTABSPACE";
    
ALTER TABLE HOMEPAGE.MT_CFG_DEFINITIONS
	ADD (CONSTRAINT PK_MT_CFG_DEFINITION PRIMARY KEY (DEFINITION_ID) USING INDEX TABLESPACE "HOMEPAGEINDEXTABSPACE");
	

CREATE UNIQUE INDEX HOMEPAGE.UNQ_NAME
	ON HOMEPAGE.MT_CFG_DEFINITIONS (NAME) TABLESPACE "HPNTINDEXTABSPACE";

	
ALTER TABLE HOMEPAGE.MT_CFG_DEFINITIONS ENABLE ROW MOVEMENT;	

-----------------------------------------------------
--  HOMEPAGE.MT_CFG_SETTINGS
-----------------------------------------------------
CREATE TABLE HOMEPAGE.MT_CFG_SETTINGS (
	SETTING_ID		VARCHAR2(36) NOT NULL,
	ORGANIZATION_ID	VARCHAR2(36) NOT NULL,
	NAME			VARCHAR2(128) NOT NULL,
	VALUE			VARCHAR2(256),
	CAN_MODIFY		NUMBER(5,0) DEFAULT 0 NOT NULL
)
TABLESPACE "HOMEPAGEREGTABSPACE";

ALTER TABLE HOMEPAGE.MT_CFG_SETTINGS
	ADD (CONSTRAINT PK_MT_CFG_SETTINGS PRIMARY KEY (SETTING_ID) USING INDEX TABLESPACE "HOMEPAGEINDEXTABSPACE");

ALTER TABLE HOMEPAGE.MT_CFG_SETTINGS 
	ADD CONSTRAINT FK_CFG_SET_ORG_ID FOREIGN KEY (ORGANIZATION_ID) 
	REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID); 	
	
CREATE UNIQUE INDEX HOMEPAGE.UNQ_ORG_NAME
	ON HOMEPAGE.MT_CFG_SETTINGS (NAME, ORGANIZATION_ID) TABLESPACE "HPNTINDEXTABSPACE";
	
	
	
ALTER TABLE HOMEPAGE.MT_CFG_SETTINGS ENABLE ROW MOVEMENT;

-----------------------------------------------------
--  HOMEPAGE.MT_CFG_FILES
-- 	TYPE: 0: BINARY FILE, 1: TXT FILE, 2: CONFIGURATION FILE
-----------------------------------------------------
CREATE TABLE HOMEPAGE.MT_CFG_FILES (
	FILE_ID			VARCHAR2(36) NOT NULL,
	SETTING_ID		VARCHAR2(36) NOT NULL,
	TYPE			NUMBER(5,0) NOT NULL, 
	FILENAME		VARCHAR2(256),		
	CACHE			NUMBER(5,0) DEFAULT 0 NOT NULL,
	C_CONTENT		CLOB,
	B_CONTENT		BLOB,
	ORGANIZATION_ID	VARCHAR2(36) NOT NULL
)
LOB (C_CONTENT) STORE AS (TABLESPACE NEWSLOBTABSPACE STORAGE (INITIAL 1M) CHUNK 4000 NOCACHE NOLOGGING),
LOB (B_CONTENT) STORE AS (TABLESPACE NEWSLOBTABSPACE STORAGE (INITIAL 1M) CHUNK 4000 NOCACHE NOLOGGING)
TABLESPACE "HOMEPAGEREGTABSPACE";

ALTER TABLE HOMEPAGE.MT_CFG_FILES
	ADD (CONSTRAINT PK_MT_CFG_FILE PRIMARY KEY (FILE_ID) USING INDEX TABLESPACE "HOMEPAGEINDEXTABSPACE");

ALTER TABLE HOMEPAGE.MT_CFG_FILES 
	ADD CONSTRAINT FK_SETTING_ID FOREIGN KEY (SETTING_ID) REFERENCES HOMEPAGE.MT_CFG_SETTINGS (SETTING_ID);

CREATE UNIQUE INDEX HOMEPAGE.UNQ_SETTING
	ON HOMEPAGE.MT_CFG_FILES (SETTING_ID) TABLESPACE "HPNTINDEXTABSPACE";
	
ALTER TABLE HOMEPAGE.MT_CFG_FILES 
	ADD CONSTRAINT FK_CFG_FILE_ORG_ID FOREIGN KEY (ORGANIZATION_ID) 
	REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);	

ALTER TABLE HOMEPAGE.MT_CFG_FILES ENABLE ROW MOVEMENT;

-- 89575: Add new entry to MT_ORGANIZATION table in initData for on premise organization
UPDATE HOMEPAGE.MT_ORGANIZATION SET ORGANIZATION_EXID = '00000000-0000-0000-0000-000000000000' WHERE ORGANIZATION_ID ='00000000-0000-0000-0000-000000000000';

-----------------------------------------------------------------------------------------------------------------------------------------------------------
-- 91299: Database schema updates to support per-user performances and DAO layer
-----------------------------------------------------------------------------------------------------------------------------------------------------------

-----------------------------------------
-- HOMEPAGE.USER_PREFS
-----------------------------------------
CREATE TABLE HOMEPAGE.HP_USER_PREFS (
	USER_PREFS_ID VARCHAR2(36) NOT NULL,
	PERSON_ID VARCHAR2(36) NOT NULL,
	PREF_NAME VARCHAR2(400),
	PREF_VALUE VARCHAR2(1536),
	LAST_UPDATE TIMESTAMP,
	CREATE_DATE TIMESTAMP,
	ORGANIZATION_ID VARCHAR2(36) DEFAULT '00000000-0000-0000-0000-000000000000'
)
TABLESPACE "HOMEPAGEREGTABSPACE";

ALTER TABLE HOMEPAGE.HP_USER_PREFS
    ADD (CONSTRAINT PK_USER_PREFS_ID PRIMARY KEY(USER_PREFS_ID)  USING INDEX TABLESPACE "HOMEPAGEINDEXTABSPACE");

ALTER TABLE HOMEPAGE.HP_USER_PREFS 
	ADD CONSTRAINT FK_USER_PREFS_PERS_ID FOREIGN KEY (PERSON_ID) REFERENCES HOMEPAGE.PERSON (PERSON_ID);
	
ALTER TABLE HOMEPAGE.HP_USER_PREFS 
	ADD CONSTRAINT FK_USER_PREFS_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);

CREATE INDEX HOMEPAGE.USER_PREF_NAME_IDX
	ON HOMEPAGE.HP_USER_PREFS (PREF_NAME) TABLESPACE "HPNTINDEXTABSPACE";

CREATE INDEX HOMEPAGE.USER_PREF_PER_IDX
	ON  HOMEPAGE.HP_USER_PREFS (PERSON_ID) TABLESPACE "HPNTINDEXTABSPACE";

CREATE UNIQUE INDEX HOMEPAGE.USER_PREF_PER_NAME_UNQ
	ON  HOMEPAGE.HP_USER_PREFS (PERSON_ID, PREF_NAME) TABLESPACE "HPNTINDEXTABSPACE";

COMMIT;

ALTER TABLE HOMEPAGE.HP_USER_PREFS ENABLE ROW MOVEMENT;
COMMIT;

----------------------------------------------------
------------------------ END   HP FIXUP 451 -------
----------------------------------------------------