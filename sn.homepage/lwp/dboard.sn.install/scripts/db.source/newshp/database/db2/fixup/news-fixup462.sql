-- ***************************************************************** 
--                                                                   
-- IBM Confidential                                                  
--                                                                   
-- OCO Source Materials                                              
--                                                                   
-- Copyright IBM Corp. 2007, 2015                                    
--                                                                   
-- The source code for this program is not published or otherwise    
-- divested of its trade secrets, irrespective of what has been      
-- deposited with the U.S. Copyright Office.                         
--                                                                   
-- ***************************************************************** 

-- {COPYRIGHT}

---------------------------------------------------------------------------------
------------------------ START NEWS FIXUP 462 -----------------------------------
---------------------------------------------------------------------------------

-- 100357: [fixup462] create a new index in NR_RESOURCE table: CONTAINER_NAME + ORGANIZATION_ID - unique index
CREATE INDEX NR_RES_CONT_NAME_ORG_ID_IDX
	ON HOMEPAGE.NR_RESOURCE (CONTAINER_NAME, ORGANIZATION_ID)@
COMMIT@

-- 81806: [fixup462.sql] Remove NR_SOURCE table and relevant DAO and Service layer
DROP TABLE HOMEPAGE.NR_SOURCE@
COMMIT@

-- 101900: [fixup462.sql] [G2, Homepage sql running poorly in G2 (European Data Cernter, Staging Environment). (122357)]
CREATE INDEX HOMEPAGE.NR_EMD_RES_PRF_PER_FRQ_RES_IDX 
	ON HOMEPAGE.EMD_RESOURCE_PREF (PERSON_ID, FREQUENCY_TYPE, RESOURCE_TYPE)@
COMMIT@	


DROP INDEX HOMEPAGE.SAVED_READERS_SR_IX@
COMMIT@

--  [start indexes] NR_AGGREGATED_READERS
DROP  INDEX HOMEPAGE.AGGREGATED_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_AGGREGATED_READERS

--  [start indexes] NR_RESPONSES_READERS
DROP  INDEX HOMEPAGE.RESPONSES_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_RESPONSES_READERS

--  [start indexes] NR_PROFILES_READERS
DROP  INDEX HOMEPAGE.PROFILES_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_PROFILES_READERS

--  [start indexes] NR_COMMUNITIES_READERS
DROP  INDEX HOMEPAGE.COMM_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_COMMUNITIES_READERS

--  [start indexes] NR_ACTIVITIES_READERS
DROP  INDEX HOMEPAGE.ACTIVITIES_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_ACTIVITIES_READERS

--  [start indexes] NR_BLOGS_READERS
DROP  INDEX HOMEPAGE.BLOGS_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_BLOGS_READERS

--  [start indexes] NR_BOOKMARKS_READERS
DROP  INDEX HOMEPAGE.BOOKMARKS_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_BOOKMARKS_READERS

--  [start indexes] NR_FILES_READERS
DROP  INDEX HOMEPAGE.FILES_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_FILES_READERS

--  [start indexes] NR_FORUMS_READERS
DROP  INDEX HOMEPAGE.FORUMS_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_FORUMS_READERS

--  [start indexes] NR_WIKIS_READERS
DROP  INDEX HOMEPAGE.WIKIS_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_WIKIS_READERS

--  [start indexes] NR_TAGS_READERS
DROP  INDEX HOMEPAGE.TAGS_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_TAGS_READERS

--  [start indexes] NR_STATUS_UPDATE_READERS
DROP  INDEX HOMEPAGE.STATUS_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_STATUS_UPDATE_READERS

--  [start indexes] NR_EXTERNAL_READERS
DROP  INDEX HOMEPAGE.EXTERNAL_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_EXTERNAL_READERS

--  [start indexes] NR_ACTIONABLE_READERS
DROP  INDEX HOMEPAGE.ACTIONABLE_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_ACTIONABLE_READERS

--  [start indexes] NR_DISCOVERY_VIEW

--  [end indexes] NR_DISCOVERY_VIEW

--  [start indexes] NR_PROFILES_VIEW
DROP  INDEX HOMEPAGE.PROFILES_VIEW_RDR_STR@
COMMIT@

--  [end indexes] NR_PROFILES_VIEW

--  [start indexes] NR_NOTIFICATION_SENT_READERS
DROP  INDEX HOMEPAGE.NOTIFICA_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_NOTIFICATION_SENT_READERS

--  [start indexes] NR_NOTIFICATION_RECEIV_READERS
DROP  INDEX HOMEPAGE.NOT_REC_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_NOTIFICATION_RECEIV_READERS

--  [start indexes] NR_SAVED_READERS
DROP  INDEX HOMEPAGE.SAVED_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_SAVED_READERS

--  [start indexes] NR_TOPICS_READERS
DROP  INDEX HOMEPAGE.TOPICS_READERS_RDR_STR@
COMMIT@

--  [end indexes] NR_TOPICS_READERS

--  [start indexes] NR_MENTIONS_READERS
DROP  INDEX HOMEPAGE.MENTIONS_READERS_RDR_STR@
COMMIT@

--  [start indexes] NR_AGGREGATED_READERS
CREATE  INDEX HOMEPAGE.AGGREGATED_READERS_STR_RDR 
 	ON HOMEPAGE.NR_AGGREGATED_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_AGGREGATED_READERS

--  [start indexes] NR_RESPONSES_READERS
CREATE  INDEX HOMEPAGE.RESPONSES_READERS_STR_RDR 
 	ON HOMEPAGE.NR_RESPONSES_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_RESPONSES_READERS

--  [start indexes] NR_PROFILES_READERS
CREATE  INDEX HOMEPAGE.PROFILES_READERS_STR_RDR 
 	ON HOMEPAGE.NR_PROFILES_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_PROFILES_READERS

--  [start indexes] NR_COMMUNITIES_READERS
CREATE  INDEX HOMEPAGE.COMM_READERS_STR_RDR 
 	ON HOMEPAGE.NR_COMMUNITIES_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_COMMUNITIES_READERS

--  [start indexes] NR_ACTIVITIES_READERS
CREATE  INDEX HOMEPAGE.ACTIVITIES_READERS_STR_RDR 
 	ON HOMEPAGE.NR_ACTIVITIES_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_ACTIVITIES_READERS

--  [start indexes] NR_BLOGS_READERS
CREATE  INDEX HOMEPAGE.BLOGS_READERS_STR_RDR 
 	ON HOMEPAGE.NR_BLOGS_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_BLOGS_READERS

--  [start indexes] NR_BOOKMARKS_READERS
CREATE  INDEX HOMEPAGE.BOOKMARKS_READERS_STR_RDR 
 	ON HOMEPAGE.NR_BOOKMARKS_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_BOOKMARKS_READERS

--  [start indexes] NR_FILES_READERS
CREATE  INDEX HOMEPAGE.FILES_READERS_STR_RDR 
 	ON HOMEPAGE.NR_FILES_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_FILES_READERS

--  [start indexes] NR_FORUMS_READERS
CREATE  INDEX HOMEPAGE.FORUMS_READERS_STR_RDR 
 	ON HOMEPAGE.NR_FORUMS_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_FORUMS_READERS

--  [start indexes] NR_WIKIS_READERS
CREATE  INDEX HOMEPAGE.WIKIS_READERS_STR_RDR 
 	ON HOMEPAGE.NR_WIKIS_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_WIKIS_READERS

--  [start indexes] NR_TAGS_READERS
CREATE  INDEX HOMEPAGE.TAGS_READERS_STR_RDR 
 	ON HOMEPAGE.NR_TAGS_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_TAGS_READERS

--  [start indexes] NR_STATUS_UPDATE_READERS
CREATE  INDEX HOMEPAGE.STATUS_READERS_STR_RDR 
 	ON HOMEPAGE.NR_STATUS_UPDATE_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_STATUS_UPDATE_READERS

--  [start indexes] NR_EXTERNAL_READERS
CREATE  INDEX HOMEPAGE.EXTERNAL_READERS_STR_RDR 
 	ON HOMEPAGE.NR_EXTERNAL_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_EXTERNAL_READERS

--  [start indexes] NR_ACTIONABLE_READERS
CREATE  INDEX HOMEPAGE.ACTIONABLE_READERS_STR_RDR 
 	ON HOMEPAGE.NR_ACTIONABLE_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_ACTIONABLE_READERS

--  [start indexes] NR_DISCOVERY_VIEW
CREATE  INDEX HOMEPAGE.DISCOVERY_VIEW_STR_RDR 
 	ON HOMEPAGE.NR_DISCOVERY_VIEW (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_DISCOVERY_VIEW

--  [start indexes] NR_PROFILES_VIEW
CREATE  INDEX HOMEPAGE.PROFILES_VIEW_STR_RDR 
 	ON HOMEPAGE.NR_PROFILES_VIEW (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_PROFILES_VIEW

--  [start indexes] NR_NOTIFICATION_SENT_READERS
CREATE  INDEX HOMEPAGE.NOTIFICA_READERS_STR_RDR 
 	ON HOMEPAGE.NR_NOTIFICATION_SENT_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_NOTIFICATION_SENT_READERS

--  [start indexes] NR_NOTIFICATION_RECEIV_READERS
CREATE  INDEX HOMEPAGE.NOT_REC_READERS_STR_RDR 
 	ON HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_NOTIFICATION_RECEIV_READERS

--  [start indexes] NR_SAVED_READERS
CREATE  INDEX HOMEPAGE.SAVED_READERS_STR_RDR 
 	ON HOMEPAGE.NR_SAVED_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_SAVED_READERS

--  [start indexes] NR_TOPICS_READERS
CREATE  INDEX HOMEPAGE.TOPICS_READERS_STR_RDR 
 	ON HOMEPAGE.NR_TOPICS_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_TOPICS_READERS

--  [start indexes] NR_MENTIONS_READERS
CREATE  INDEX HOMEPAGE.MENTIONS_READERS_STR_RDR 
 	ON HOMEPAGE.NR_MENTIONS_READERS (STORY_ID, READER_ID)@ 
COMMIT@

--  [end indexes] NR_MENTIONS_READERS

	
---------------------------------------------------------------------------------
------------------------ END   NEWS FIXUP 462 -------------------------------------
---------------------------------------------------------------------------------



-- 102461: [fixp462] drop column NOTE_TEXT from SAVED and ACTIONABLE readers
ALTER TABLE HOMEPAGE.NR_ACTIONABLE_READERS DROP COLUMN NOTE_TEXT@
COMMIT@
ALTER TABLE HOMEPAGE.NR_ACTIONABLE_READERS DROP COLUMN NOTE_UPDATE_DATE@
COMMIT@
REORG TABLE HOMEPAGE.NR_ACTIONABLE_READERS@
COMMIT@

-- 102831: [fixup462] create un unique index on NR_SOURCE_TYPE (source + orgId)
CREATE UNIQUE INDEX HOMEPAGE.UNQ_SOURCE_TYPE_SRC_ORG
 	ON HOMEPAGE.NR_SOURCE_TYPE (SOURCE, ORGANIZATION_ID)@
COMMIT@

-- 103237: OSC 121178 - Reply to a topic notification shows as reply to a reply
-- 111614: [News] The property rollupName@rollupHtmlPath cannot be found or is not set in the event record with name forum.topic.recommended.
UPDATE HOMEPAGE.NR_TEMPLATE SET DATA_SOURCE_STRING = 'rollupName;rollupHtmlPath' WHERE NAME = 'topicEntryName'@
COMMIT@

INSERT INTO HOMEPAGE.NR_TEMPLATE
                (TEMPLATE_ID, NAME, DATA_SOURCE_STRING, FORMAT, NO_VALUES)
VALUES  ('general-rollupitem-asdfbe898Bjr95','rollupitem','rollupName@rollupHtmlPath', 'link', 1)@
COMMIT@
