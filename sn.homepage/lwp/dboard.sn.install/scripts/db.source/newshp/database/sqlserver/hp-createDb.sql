-- ***************************************************************** 
--                                                                   
-- IBM Confidential                                                  
--                                                                   
-- OCO Source Materials                                              
--                                                                   
-- Copyright IBM Corp. 2007, 2017                                    
--                                                                   
-- The source code for this program is not published or otherwise    
-- divested of its trade secrets, irrespective of what has been      
-- deposited with the U.S. Copyright Office.                         
--                                                                   
-- ***************************************************************** 

-- {COPYRIGHT}

-----------------------------------------------------------------------
-- ADDING new HOMEPAGE.MT_ORGANIZATION table
-----------------------------------------------------------------------
CREATE TABLE HOMEPAGE.MT_ORGANIZATION (
    ORGANIZATION_ID nvarchar (36) NOT NULL,
    ORGANIZATION_EXID nvarchar (36) -- note is nullable for premises IC deployment
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.MT_ORGANIZATION
    ADD CONSTRAINT PK_ORGANIZATION_ID PRIMARY KEY(ORGANIZATION_ID);
    
CREATE UNIQUE INDEX UNQ_ORG_EXID
	ON HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_EXID);
	
GO    

------------------------------------------------
-- PERSON
------------------------------------------------ 
CREATE TABLE HOMEPAGE.PERSON  (
	PERSON_ID nvarchar(36) NOT NULL,
	DISPLAYNAME nvarchar(256) NOT NULL,
	EXID nvarchar(256) NOT NULL,
	USER_MAIL nvarchar(256),
	USER_MAIL_LOWER nvarchar(256),
	DISPLAYNAME_LOWER nvarchar(256),
	STATE NUMERIC(5,0) DEFAULT 0 NOT NULL,
	LAST_UPDATE DATETIME2(3),
	SAND_OPT NUMERIC(5,0) DEFAULT 1,
	SAND_LAST_UPDATE DATETIME2(3) DEFAULT CURRENT_TIMESTAMP,
	PROF_TYPE nvarchar(128),
	CREATION_DATE DATETIME2(3),
	THEME_ID nvarchar(36),
	COMM_VISIBILITY NUMERIC(5 ,0),
	MEMBER_TYPE NUMERIC(5 ,0) DEFAULT 0 NOT NULL,
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000',
	COMMUNITY_INTERNAL_ONLY NUMERIC(5 ,0) DEFAULT 1,
	LAST_CONN_VISIT DATETIME2(3),
	PREF_LANG nvarchar(5),
	IS_EXTERNAL NUMERIC(5 ,0) DEFAULT 0 NOT NULL,
	HOME_ORG_ID nvarchar(36)
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.PERSON
   ADD CONSTRAINT PK_PERSON_ID PRIMARY KEY (PERSON_ID);  
   
ALTER TABLE HOMEPAGE.PERSON ADD CONSTRAINT FK_PERSON_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);

CREATE UNIQUE INDEX PERSON_EXID_ORG
	ON HOMEPAGE.PERSON (EXID, ORGANIZATION_ID);	

CREATE INDEX PERSON_EMD_CHECK 
	ON HOMEPAGE.PERSON (MEMBER_TYPE, CREATION_DATE ASC, STATE, USER_MAIL_LOWER, PERSON_ID, ORGANIZATION_ID); 

CREATE INDEX PERSON_USER_MAIL_LWR
    ON HOMEPAGE.PERSON(USER_MAIL_LOWER ASC);

CREATE INDEX PERSON_DISPLAYNAME_LWR
    ON HOMEPAGE.PERSON(DISPLAYNAME_LOWER ASC);

CREATE INDEX PERSON_LAST_UPDATE
    ON HOMEPAGE.PERSON (LAST_UPDATE DESC);    

CREATE INDEX PERSON_SAND_LAST_UPDATE
    ON HOMEPAGE.PERSON (SAND_LAST_UPDATE ASC);    

CREATE UNIQUE INDEX PERSON_IDX   
	ON HOMEPAGE.PERSON (PERSON_ID) INCLUDE (USER_MAIL, DISPLAYNAME);

CREATE INDEX DISPLAYNAME_LOWER_MEM
	ON HOMEPAGE.PERSON (DISPLAYNAME_LOWER, MEMBER_TYPE);

CREATE INDEX PERSON_EXID_PER_ID_IX
	ON HOMEPAGE.PERSON  (EXID, PERSON_ID);

CREATE INDEX PERSON_STATE_MEM_LU_IX
	ON HOMEPAGE.PERSON  (STATE, MEMBER_TYPE,LAST_UPDATE);

CREATE INDEX PERSON_MEM_STATE_IX
	ON HOMEPAGE.PERSON  (MEMBER_TYPE,STATE);

CREATE INDEX PERSON_MEM_SAND_IX
	ON HOMEPAGE.PERSON  (MEMBER_TYPE,SAND_OPT);
	
CREATE INDEX PERSON_SND_SR 
	ON HOMEPAGE.PERSON (MEMBER_TYPE, SAND_OPT, SAND_LAST_UPDATE ASC);	

CREATE INDEX PERSON_LAST_CONN_VISIT
    ON HOMEPAGE.PERSON(LAST_CONN_VISIT DESC);	

CREATE INDEX PERSON_EXID_STATE
	ON HOMEPAGE.PERSON  (EXID, STATE);
	
-- search indexes    
CREATE INDEX PERSON_SAND_OPT_IDX
    ON HOMEPAGE.PERSON(SAND_OPT, SAND_LAST_UPDATE ASC)
GO

CREATE INDEX PERSON_STATE_IDX
  ON HOMEPAGE.PERSON(MEMBER_TYPE, LAST_UPDATE ASC, STATE, PERSON_ID)
GO	
   
GO

------------------------------------------------
-- PERSON_ROLE
------------------------------------------------

CREATE TABLE HOMEPAGE.PERSON_ROLE  (
	PERSON_ROLE_ID NVARCHAR(36) NOT NULL PRIMARY KEY,
	ROLE NVARCHAR(256) NOT NULL,
	PERSON_ID NVARCHAR(36) NOT NULL,
	ORGANIZATION_ID NVARCHAR(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO
    
ALTER TABLE HOMEPAGE.PERSON_ROLE ADD CONSTRAINT FK_PERSON_ROLE_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID)
GO

ALTER TABLE HOMEPAGE.PERSON_ROLE ADD CONSTRAINT FK_PERSON_ROLE_PER_ID FOREIGN KEY (PERSON_ID) REFERENCES HOMEPAGE.PERSON (PERSON_ID)
GO

CREATE INDEX PERSON_ROLE_PER_IDX
    ON HOMEPAGE.PERSON_ROLE (PERSON_ID);
    
CREATE INDEX PERSON_ROLE_PER_R_IDX
    ON HOMEPAGE.PERSON_ROLE (PERSON_ID, PERSON_ROLE_ID);
    
CREATE UNIQUE INDEX PERSON_ROLE_ROLE_IDX
    ON HOMEPAGE.PERSON_ROLE (PERSON_ID, ROLE);
    
GO

-- LL requirement
------------------------------------------------
-- SNCORE_PERSON
------------------------------------------------ 
CREATE VIEW HOMEPAGE.SNCORE_PERSON (SNC_INTERNAL_ID, SNC_IDKEY, SNC_EMAIL_LOWER, SNC_DISPLAY_NAME) 
    AS SELECT PERSON_ID, EXID, USER_MAIL_LOWER, DISPLAYNAME FROM HOMEPAGE.PERSON;
GO  

-----------------------------------------
-- HOMEPAGE.USER_PREFS
-----------------------------------------
CREATE TABLE HOMEPAGE.HP_USER_PREFS (
	USER_PREFS_ID nvarchar(36) NOT NULL,
	PERSON_ID nvarchar(36) NOT NULL,
	PREF_NAME nvarchar(400),
	PREF_VALUE nvarchar(1536),
	LAST_UPDATE DATETIME2(3),
	CREATE_DATE DATETIME2(3),
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
)  ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.HP_USER_PREFS
    ADD CONSTRAINT PK_USER_PREFS_ID PRIMARY KEY(USER_PREFS_ID);

ALTER TABLE HOMEPAGE.HP_USER_PREFS 
	ADD CONSTRAINT FK_USER_PREFS_PERS_ID FOREIGN KEY (PERSON_ID) REFERENCES HOMEPAGE.PERSON (PERSON_ID);
	
ALTER TABLE HOMEPAGE.HP_USER_PREFS 
	ADD CONSTRAINT FK_USER_PREFS_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);

CREATE INDEX USER_PREF_NAME_IDX
	ON HOMEPAGE.HP_USER_PREFS (PREF_NAME);

CREATE INDEX USER_PREF_PER_IDX
	ON  HOMEPAGE.HP_USER_PREFS (PERSON_ID);

CREATE UNIQUE INDEX USER_PREF_PER_NAME_UNQ
	ON  HOMEPAGE.HP_USER_PREFS (PERSON_ID, PREF_NAME);
	
GO	

------------------------------------------------
-- LOGINNAME
------------------------------------------------ 
CREATE TABLE HOMEPAGE.LOGINNAME (
	PERSON_ID nvarchar(36) NOT NULL,
	LOGINNAME nvarchar(256) NOT NULL,
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.LOGINNAME
	ADD CONSTRAINT PK_LOGINNAME_ID PRIMARY KEY (PERSON_ID,LOGINNAME);

ALTER TABLE HOMEPAGE.LOGINNAME
	ADD CONSTRAINT FK_LN_PERSON_ID FOREIGN KEY (PERSON_ID)
	REFERENCES HOMEPAGE.PERSON (PERSON_ID);
	
ALTER TABLE HOMEPAGE.LOGINNAME ADD CONSTRAINT FK_LN_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);

CREATE UNIQUE INDEX LOGINNAME_UNIQUE
    ON HOMEPAGE.LOGINNAME (LOGINNAME, ORGANIZATION_ID);

------------------------------------------------
-- HP_UI
------------------------------------------------ 
CREATE TABLE HOMEPAGE.HP_UI  (
	UI_ID nvarchar(36) NOT NULL,
	PERSON_ID nvarchar(36) NOT NULL,
	PERSON_LANG nvarchar(5) NOT NULL,
	LAST_VISIT DATETIME2(3) NOT NULL,
	WELCOME_MODE NUMERIC(5,0) NOT NULL DEFAULT 1,
	SHOW_DISABLED_WIDGETS NUMERIC(5,0) NOT NULL DEFAULT 0,
	LAST_NOTIFY_VISIT DATETIME2(3),
	LAST_ACTIONABLE_VISIT DATETIME2(3),
	WELCOME_NOTE NUMERIC(5,0) DEFAULT 1,
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.HP_UI
    ADD CONSTRAINT PK_HP_UI PRIMARY KEY (UI_ID);

ALTER TABLE HOMEPAGE.HP_UI
    ADD CONSTRAINT FK_UI_PERSON_ID FOREIGN KEY (PERSON_ID)
	REFERENCES HOMEPAGE.PERSON (PERSON_ID);
	
ALTER TABLE HOMEPAGE.HP_UI ADD CONSTRAINT FK_UI_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);

CREATE UNIQUE INDEX HP_UI_PERSONID
	ON HOMEPAGE.HP_UI (PERSON_ID) INCLUDE (PERSON_LANG);
	
CREATE INDEX HP_UI_R
	ON HOMEPAGE.HP_UI (LAST_VISIT);

	

------------------------------------------------
-- HP_TAB
------------------------------------------------ 
CREATE TABLE HOMEPAGE.HP_TAB  (
	TAB_ID nvarchar(36) NOT NULL,
	DEFAULT_NAME nvarchar(36) NOT NULL,
	DEFAULT_N_COLUMNS NUMERIC(5, 0) NOT NULL DEFAULT 0,
	IS_NAME_CHANGEABLE NUMERIC(5,0) NOT NULL DEFAULT 0,
	ENABLED NUMERIC(5,0) DEFAULT 1,
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.HP_TAB
    ADD CONSTRAINT PK_HP_TAB PRIMARY KEY (TAB_ID);
    
ALTER TABLE HOMEPAGE.HP_TAB ADD CONSTRAINT FK_TAB_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);
    


------------------------------------------------
-- HP_TAB_INST
------------------------------------------------ 
CREATE TABLE HOMEPAGE.HP_TAB_INST  (
	TAB_INST_ID nvarchar(36) NOT NULL,
	TAB_ID nvarchar(36) NOT NULL,
	UI_ID nvarchar(36) NOT NULL,
	TAB_NAME nvarchar(36),
	N_COLUMNS NUMERIC(5, 0) NOT NULL DEFAULT 0,
	LAST_MODIFIED DATETIME2(3) NOT NULL,
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.HP_TAB_INST
    ADD CONSTRAINT PK_HP_TAB_INST PRIMARY KEY (TAB_INST_ID);

ALTER TABLE HOMEPAGE.HP_TAB_INST
    ADD CONSTRAINT FK_UI_ID FOREIGN KEY (UI_ID)
	REFERENCES HOMEPAGE.HP_UI(UI_ID);

ALTER TABLE HOMEPAGE.HP_TAB_INST
    ADD CONSTRAINT FK_TAB_INST_TAB_ID FOREIGN KEY (TAB_ID)
	REFERENCES HOMEPAGE.HP_TAB(TAB_ID);

ALTER TABLE HOMEPAGE.HP_TAB_INST ADD CONSTRAINT FK_TAB_INST_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);
	
CREATE INDEX TAB_INST_UI_ID_IDX 
	ON HOMEPAGE.HP_TAB_INST(UI_ID);
	
CREATE INDEX TAB_INST_TAB_ID 
	ON HOMEPAGE.HP_TAB_INST (TAB_ID);
	
CREATE UNIQUE INDEX HP_TAB_INST_UNQ 
	ON HOMEPAGE.HP_TAB_INST (TAB_ID, UI_ID);	

------------------------------------------------
-- WIDGET
------------------------------------------------ 
CREATE TABLE HOMEPAGE.WIDGET (
	WIDGET_ID nvarchar(36) NOT NULL,
	WIDGET_TITLE nvarchar(256) NOT NULL,
	WIDGET_TEXT nvarchar(256),
	WIDGET_URL nvarchar(256) NOT NULL,
	WIDGET_ICON nvarchar(256),
	WIDGET_ENABLED NUMERIC(5,0) NOT NULL DEFAULT 0,
	WIDGET_SYSTEM NUMERIC(5,0) NOT NULL DEFAULT 0,
	WIDGET_HOMEPAGE_SPECIFIC NUMERIC(5,0) NOT NULL DEFAULT 0,
	WIDGET_PREVIEW_IMAGE nvarchar(256),
	WIDGET_CATEGORY nvarchar(36) DEFAULT ' ' NOT NULL,
	WIDGET_IS_DEFAULT_OPENED NUMERIC(5,0) NOT NULL DEFAULT 0,
	WIDGET_MULTIPLE_INSTANCES NUMERIC(5,0) NOT NULL DEFAULT 0,
	WIDGET_MARKED_CACHABLE NUMERIC(5,0) NOT NULL DEFAULT 0,
	WIDGET_SECURE_URL nvarchar(256) DEFAULT '',
	WIDGET_SECURE_ICON nvarchar(256) DEFAULT '',
	IS_GADGET NUMERIC(5,0) DEFAULT 0,
	WIDGET_POLICY_FLAGS NUMERIC(5,0) DEFAULT 1 NOT NULL,
	WIDGET_EXT_PROPERTIES nvarchar(2048),
	PROXY_POLICY nvarchar(64) DEFAULT 'custom' NOT NULL,
	SHARE_ORDER NUMERIC(9,0) DEFAULT -1 NOT NULL,
	SERVER_ACCESS NVARCHAR(MAX),
	ADDITIONAL_FEATURES NVARCHAR(MAX),
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.WIDGET 
	ADD CONSTRAINT PK_WIDGET PRIMARY KEY (WIDGET_ID);

ALTER TABLE HOMEPAGE.WIDGET ADD CONSTRAINT FK_WIDGET_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);
	
GO

------------------------------------------------
-- HP_WIDGET_TAB
------------------------------------------------ 
CREATE TABLE HOMEPAGE.HP_WIDGET_TAB (
	WIDGET_TAB_ID nvarchar(36) NOT NULL,
	WIDGET_ID nvarchar(36) NOT NULL,
	TAB_ID nvarchar(36) NOT NULL,
	TYPE nvarchar(36) NOT NULL,
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.HP_WIDGET_TAB 
	ADD CONSTRAINT PK_WIDGET_TAB PRIMARY KEY (WIDGET_TAB_ID);

ALTER TABLE HOMEPAGE.HP_WIDGET_TAB	
    ADD CONSTRAINT FK_WID_TAB_WID_ID FOREIGN KEY (WIDGET_ID)
	REFERENCES HOMEPAGE.WIDGET (WIDGET_ID);

ALTER TABLE HOMEPAGE.HP_WIDGET_TAB	
    ADD CONSTRAINT FK_WID_TAB_TAB_ID FOREIGN KEY (TAB_ID)
	REFERENCES HOMEPAGE.HP_TAB (TAB_ID);

ALTER TABLE HOMEPAGE.HP_WIDGET_TAB ADD CONSTRAINT FK_WIDGET_TAB_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);
	

------------------------------------------------
-- HP_WIDGET_INST
------------------------------------------------ 
CREATE TABLE HOMEPAGE.HP_WIDGET_INST  (
	WIDGET_INST_ID nvarchar(36) NOT NULL,
	WIDGET_ID nvarchar(36) NOT NULL,
	TAB_INST_ID nvarchar(36) NOT NULL,
	WIDGET_SETTING nvarchar(2048),
	CONTAINER nvarchar(36),
	ORDER_SEQUENCE NUMERIC(5, 0),
	IS_FIXED NUMERIC(5,0),
	IS_TOGGLED NUMERIC(5,0),
	LAST_MODIFIED DATETIME2(3) NOT NULL,
	LAST_UPDATED DATETIME2(3),
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.HP_WIDGET_INST
	ADD CONSTRAINT PK_HP_WIDGET_INST PRIMARY KEY (WIDGET_INST_ID);

ALTER TABLE HOMEPAGE.HP_WIDGET_INST
    ADD CONSTRAINT FK_WIDGET_ID FOREIGN KEY (WIDGET_ID)
	REFERENCES HOMEPAGE.WIDGET (WIDGET_ID);

ALTER TABLE HOMEPAGE.HP_WIDGET_INST
    ADD CONSTRAINT FK_TAB_INST_ID FOREIGN KEY (TAB_INST_ID)
	REFERENCES HOMEPAGE.HP_TAB_INST (TAB_INST_ID);

ALTER TABLE HOMEPAGE.HP_WIDGET_INST ADD CONSTRAINT FK_WIDGET_INST_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);
	
CREATE INDEX WIDGET_INST
	ON HOMEPAGE.HP_WIDGET_INST (TAB_INST_ID ASC, WIDGET_ID ASC);

CREATE INDEX HP_WIDGET_INST_TAB_INST_ID_IDX
	ON HOMEPAGE.HP_WIDGET_INST(TAB_INST_ID);
	
CREATE INDEX HP_WIDGET_IDX 
	ON HOMEPAGE.HP_WIDGET_INST (WIDGET_ID);	

------------------------------------------------
-- PREREQ
------------------------------------------------ 
CREATE TABLE HOMEPAGE.PREREQ (
	PREREQ_ID nvarchar(36) NOT NULL,
	APP_ID nvarchar(36) NOT NULL,
	WIDGET_ID nvarchar(36) NOT NULL,
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.PREREQ 
	ADD CONSTRAINT PK_PREREQ PRIMARY KEY (PREREQ_ID);

ALTER TABLE HOMEPAGE.PREREQ 
	ADD CONSTRAINT FK_PREREQ_WIDGET FOREIGN KEY (WIDGET_ID)
	REFERENCES HOMEPAGE.WIDGET (WIDGET_ID)
	ON DELETE CASCADE;
	
ALTER TABLE HOMEPAGE.PREREQ ADD CONSTRAINT FK_PREREQ_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);


----------------------------------------------------------------------
-- HOMEPAGE.NT_REPLYTO
----------------------------------------------------------------------
CREATE TABLE HOMEPAGE.NT_REPLYTO (
	REPLYTO_NOTIFICATION_ID nvarchar(36) NOT NULL,
	SOURCE nvarchar(36),
	EVENT_NAME nvarchar(256) NOT NULL,
	CONTAINER_ID nvarchar(256),	
	ITEM_ID nvarchar(36),
	ITEM_CORRELATION_ID nvarchar(256),	
	CREATION_DATE DATETIME2(3) NOT NULL,
	ACTOR_UUID nvarchar(36),
	EVENT_RECORD_UUID nvarchar(36) NOT NULL,
	CATEGORY_TYPE NUMERIC(5,0),
	SOURCE_TYPE NUMERIC(5,0),
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.NT_REPLYTO
    ADD CONSTRAINT PK_REPLYTO PRIMARY KEY(REPLYTO_NOTIFICATION_ID);

ALTER TABLE HOMEPAGE.NT_REPLYTO ADD CONSTRAINT FK_REPLYTO_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);
    
GO
----------------------------------------------------------------------
-- HOMEPAGE.NT_REPLYTO_RECIPIENT
----------------------------------------------------------------------
CREATE TABLE HOMEPAGE.NT_REPLYTO_RECIPIENT (
	REPLYTO_RECIPIENT_ID nvarchar(36) NOT NULL,
	REPLYTO_NOTIFICATION_ID nvarchar(36) NOT NULL,
	PERSON_ID nvarchar(36) NOT NULL,	
	REPLYTO_ID nvarchar(36) NOT NULL,
	LAST_UPDATE DATETIME2(3),
	ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.NT_REPLYTO_RECIPIENT
    ADD CONSTRAINT REPLYTO_RECIP_ID PRIMARY KEY(REPLYTO_RECIPIENT_ID);

ALTER TABLE HOMEPAGE.NT_REPLYTO_RECIPIENT
    ADD CONSTRAINT FK_REPLYTO_NOT_ID FOREIGN KEY (REPLYTO_NOTIFICATION_ID)
	REFERENCES HOMEPAGE.NT_REPLYTO (REPLYTO_NOTIFICATION_ID);

ALTER TABLE HOMEPAGE.NT_REPLYTO_RECIPIENT
    ADD CONSTRAINT FK_REPLYTO_PER_ID FOREIGN KEY (PERSON_ID)
	REFERENCES HOMEPAGE.PERSON (PERSON_ID);
	
ALTER TABLE HOMEPAGE.NT_REPLYTO_RECIPIENT ADD CONSTRAINT FK_REPLYTO_RECIPIENT_ORG_ID FOREIGN KEY (ORGANIZATION_ID) REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);

CREATE UNIQUE INDEX REPLYTO_IDX
    ON HOMEPAGE.NT_REPLYTO_RECIPIENT (REPLYTO_ID);

GO	
----------------------------------------------------------------------
-- HOMEPAGE.MT_METRICS 
----------------------------------------------------------------------

CREATE TABLE HOMEPAGE.METRIC_STAT  (
      METRIC_STAT_ID nvarchar(36) NOT NULL,
      RECORDED_ON DATETIME2(3) NOT NULL,
      METRIC_TYPE NUMERIC(5,0) NOT NULL,
      METRIC_DESC nvarchar(36) NOT NULL,
      RES_BUNDLE_KEY nvarchar(144) NOT NULL,
      COUNT_LAST_24_H NUMERIC(19,0),
      COUNT_LAST_7_D NUMERIC(19,0),
      COUNT_LAST_1_M NUMERIC(19,0),
      TOP_STATS nvarchar(512),
      TOT_STAT NUMERIC(19,0),
      AVG_TOT_STAT NUMERIC(19,0),
      ORGANIZATION_ID nvarchar(36) DEFAULT '00000000-0000-0000-0000-000000000000'
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.METRIC_STAT 
    ADD CONSTRAINT PK_METRIC_STAT_ID PRIMARY KEY(METRIC_STAT_ID);

CREATE INDEX METRIC_IDX
    ON HOMEPAGE.METRIC_STAT (RECORDED_ON ASC, METRIC_TYPE);
    
ALTER TABLE HOMEPAGE.METRIC_STAT 
	ADD CONSTRAINT FK_METRIC_ORG_ID FOREIGN KEY (ORGANIZATION_ID) 
	REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);  
    
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
-----------------------------**************************---------------------------------------
-----------------------------[start]---OAUTH SCHEMA --------------------------------------------
-----------------------------**************************---------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------

-------------------------------------------
-- HOMEPAGE.OAUTH1_TOKEN
-------------------------------------------	 
CREATE TABLE HOMEPAGE.OAUTH1_TOKEN (
	ID nvarchar(256) NOT NULL PRIMARY KEY,
	TOKEN nvarchar(1024) NOT NULL,
	SECRET nvarchar(1024) NOT NULL,
	EXPIRATION DATETIME2(3),
	CREATED DATETIME2(3) NOT NULL,
	MODIFIED DATETIME2(3) NOT NULL
) ON [PRIMARY]
GO

-------------------------------------------
-- HOMEPAGE.OAUTH1_PROVIDER
-------------------------------------------	 
CREATE TABLE HOMEPAGE.OAUTH1_PROVIDER (
	ID nvarchar(256) NOT NULL PRIMARY KEY,
	NAME nvarchar(254) NOT NULL,
	DESCRIPTION nvarchar(1024),
	REQUESTTOKENURL nvarchar(512) NOT NULL,
	AUTHORIZEURL nvarchar(512) NOT NULL,
	ACCESSTOKENURL nvarchar(512) NOT NULL,
	BASEURL nvarchar(512),
	MANAGEURL nvarchar(512),
	REGISTERURL nvarchar(512),
	SIGNMETHOD nvarchar(32),
	VERSION nvarchar(8),
	CREATED DATETIME2(3) NOT NULL,
	MODIFIED DATETIME2(3) NOT NULL,
	CONSTRAINT PRVD_NAME_UK UNIQUE (NAME)
) ON [PRIMARY]
GO
	
-------------------------------------------
-- HOMEPAGE.OAUTH1_CLIENT
-------------------------------------------
CREATE TABLE HOMEPAGE.OAUTH1_CLIENT (
	ID nvarchar(256) NOT NULL PRIMARY KEY,
	PERSON_ID nvarchar(36) NOT NULL,
	NAME nvarchar(254) NOT NULL,
	TOKENID nvarchar(256) NOT NULL,
	PROVIDERID nvarchar(256) NOT NULL,
	DESCRIPTION nvarchar(1024),
	CALLBACKURL nvarchar(512),	
	CREATED DATETIME2(3) NOT NULL,
	MODIFIED DATETIME2(3) NOT NULL,
	CONSTRAINT CLNT_NAME_UK UNIQUE (NAME)
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.OAUTH1_CLIENT 
	ADD CONSTRAINT CLNT_FK FOREIGN KEY (PROVIDERID) 
	REFERENCES HOMEPAGE.OAUTH1_PROVIDER(ID);

ALTER TABLE HOMEPAGE.OAUTH1_CLIENT 
	ADD CONSTRAINT CLNT_TOKEN_FK FOREIGN KEY (TOKENID) 
	REFERENCES HOMEPAGE.OAUTH1_TOKEN(ID);
	
ALTER TABLE HOMEPAGE.OAUTH1_CLIENT
	ADD CONSTRAINT FK_OA1CL_PERSON_ID FOREIGN KEY (PERSON_ID)
	REFERENCES HOMEPAGE.PERSON(PERSON_ID);		
	
GO

-------------------------------------------
-- HOMEPAGE.OAUTH1_CONTEXT
-------------------------------------------
CREATE TABLE HOMEPAGE.OAUTH1_CONTEXT (
	ID nvarchar(256) NOT NULL PRIMARY KEY,
	CLIENTID nvarchar(256) NOT NULL,
	PERSON_ID nvarchar(36),
	TOKENID nvarchar(256) NOT NULL,
	CREATED DATETIME2(3) NOT NULL,
	MODIFIED DATETIME2(3) NOT NULL,
	NONCE nvarchar(256),
	EXPIRATION DATETIME2(3),
	AUTHORIZED NUMERIC(5,0) DEFAULT 0 NOT NULL
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.OAUTH1_CONTEXT
	ADD CONSTRAINT CONTEXT_CLNT_FK FOREIGN KEY (CLIENTID) 
	REFERENCES HOMEPAGE.OAUTH1_CLIENT(ID);

ALTER TABLE HOMEPAGE.OAUTH1_CONTEXT
	ADD CONSTRAINT AUTH_TOKEN_FK FOREIGN KEY (TOKENID) 
	REFERENCES HOMEPAGE.OAUTH1_TOKEN(ID);
	
ALTER TABLE HOMEPAGE.OAUTH1_CONTEXT
	ADD CONSTRAINT FK_OA1C_PERSON_ID FOREIGN KEY (PERSON_ID)
	REFERENCES HOMEPAGE.PERSON(PERSON_ID);		

GO
	
-------------------------------------------
-- HOMEPAGE.OAUTH2_PROVIDER
-------------------------------------------
CREATE TABLE HOMEPAGE.OAUTH2_PROVIDER (
  NAME NVARCHAR(254) NOT NULL PRIMARY KEY,
  CLIENT_AUTH NVARCHAR(254),
  AUTH_HEADER SMALLINT,
  URL_PARAM SMALLINT,
  AUTH_URL NVARCHAR(1024),
  TOKEN_URL NVARCHAR(1024)
) ON [PRIMARY]
GO

-------------------------------------------
-- HOMEPAGE.OAUTH2_CLIENT
-------------------------------------------
CREATE TABLE HOMEPAGE.OAUTH2_CLIENT (
  NAME NVARCHAR(254) NOT NULL PRIMARY KEY,
  PROVIDER_NAME NVARCHAR(254) NOT NULL,
  REDIRECT_URI NVARCHAR(1024),
  CTYPE NVARCHAR(254) NOT NULL,
  GRANT_TYPE NVARCHAR(254) NOT NULL,
  CLIENT_ID NVARCHAR(1024) NOT NULL,
  CLIENT_SECRET NVARCHAR(1024) NOT NULL,
  ALLOWED_DOMAINS nvarchar(1024)
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.OAUTH2_CLIENT
  ADD CONSTRAINT FK_CLIENT_PRO_NAME FOREIGN KEY(PROVIDER_NAME)
  REFERENCES HOMEPAGE.OAUTH2_PROVIDER(NAME);
GO
    
-------------------------------------------
-- HOMEPAGE.OAUTH2_GADGET_BINDING
-------------------------------------------
CREATE TABLE HOMEPAGE.OAUTH2_GADGET_BINDING (
  ID nvarchar(36) NOT NULL PRIMARY KEY,
  WIDGET_ID nvarchar(36) NOT NULL,
  URI_SHA1 CHAR(40) NOT NULL, 
  SERVICE_NAME nvarchar(254)  NOT NULL,
  URI nvarchar(1024) NOT NULL,
  CLIENT_NAME nvarchar(254) NOT NULL,
  OVERRIDES NUMERIC(5,0) NOT NULL,
  SECURE_URI_SHA1 CHAR(40),
  SECURE_URI nvarchar(1024),
  CONSTRAINT WIDGET_GADGET_UK UNIQUE (WIDGET_ID, SERVICE_NAME)
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.OAUTH2_GADGET_BINDING
  ADD CONSTRAINT FK_BINDING_CLIENT FOREIGN KEY(CLIENT_NAME)
  REFERENCES HOMEPAGE.OAUTH2_CLIENT(NAME);

ALTER TABLE HOMEPAGE.OAUTH2_GADGET_BINDING
  ADD CONSTRAINT FK_BINDING_WIDGET FOREIGN KEY(WIDGET_ID)
  REFERENCES HOMEPAGE.WIDGET(WIDGET_ID);
  
CREATE INDEX OA2T_GBINDING_WID
	ON HOMEPAGE.OAUTH2_GADGET_BINDING (WIDGET_ID);

GO


-------------------------------------------
-- HOMEPAGE.OAUTH2_TOKEN
-------------------------------------------
CREATE TABLE HOMEPAGE.OAUTH2_TOKEN (
  ID nvarchar(254) NOT NULL PRIMARY KEY,
  URI nvarchar(1024) NOT NULL,
  SERVICE_NAME nvarchar(254) NOT NULL,
  PERSON_ID nvarchar(36) NOT NULL,
  SCOPE nvarchar(1024) NOT NULL,
  TTYPE NUMERIC(5,0) NOT NULL,
  SECRET nvarchar(1024),
  EXPIRES DATETIME2(3),
  ISSUED DATETIME2(3) NOT NULL,
  TOKEN_TYPE nvarchar(254),
  MAC_SECRET nvarchar(1024),
  MAC_ALG nvarchar(254),
  MAC_EXT nvarchar(254),
  PROPS nvarchar(1024),
  TOKEN_SHA1 CHAR(40)
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.OAUTH2_TOKEN
	ADD CONSTRAINT FK_OA2T_PERSON_ID FOREIGN KEY (PERSON_ID)
	REFERENCES HOMEPAGE.PERSON(PERSON_ID);	

CREATE INDEX OA2T_PERSON_SERVICE
	ON HOMEPAGE.OAUTH2_TOKEN (PERSON_ID, SERVICE_NAME);
	
CREATE UNIQUE INDEX OA2_TOKEN_SHA1_UNQ 
	ON HOMEPAGE.OAUTH2_TOKEN (TOKEN_SHA1);	
	
GO

-- %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
-- END OAuth Consumer Schema
-- %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

CREATE TABLE HOMEPAGE.OH2P_CACHE (
	LOOKUPKEY nvarchar(256) NOT NULL, 
	UNIQUEID nvarchar(128) NOT NULL, 
	COMPONENTID nvarchar(256) NOT NULL, 
	TYPE nvarchar(64) NOT NULL, 
	SUBTYPE nvarchar(64), 
	CREATEDAT NUMERIC(19,0), 
	LIFETIME NUMERIC(10,0), 
	EXPIRES NUMERIC(19,0), 
	TOKENSTRING nvarchar(2048) NOT NULL, 
	CLIENTID nvarchar(64) NOT NULL, 
	USERNAME nvarchar(256) NOT NULL, 
	SCOPE nvarchar(512) NOT NULL, 
	REDIRECTURI nvarchar(2048), 
	STATEID nvarchar(64) NOT NULL
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.OH2P_CACHE 
	ADD CONSTRAINT PK_LOOKUPKEY PRIMARY KEY (LOOKUPKEY);

CREATE INDEX OH2P_CACHE_EXPIRES ON HOMEPAGE.OH2P_CACHE (EXPIRES ASC);

CREATE INDEX OH2P_CACHE_CNT 
	ON HOMEPAGE.OH2P_CACHE (USERNAME, CLIENTID) INCLUDE (COMPONENTID);
	
CREATE INDEX OH2P_CACHE_DUP 
	ON HOMEPAGE.OH2P_CACHE (USERNAME ASC, EXPIRES DESC, CLIENTID ASC, TYPE ASC);	
GO


CREATE TABLE HOMEPAGE.OH2P_CLIENTCFG (
	COMPONENTID nvarchar(128) NOT NULL, 
	CLIENTID nvarchar(256) NOT NULL, 
	CLIENTSECRET nvarchar(256), 
	DISPLAYNAME nvarchar(256) NOT NULL, 
	REDIRECTURI nvarchar(2048), 
	ENABLED NUMERIC(5,0)
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.OH2P_CLIENTCFG 
	ADD CONSTRAINT PK_COMPIDCLIENTID PRIMARY KEY (COMPONENTID,CLIENTID);

GO

----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
-----------------------------**************************---------------------------------------
-----------------------------[end]---OAUTH SCHEMA --------------------------------------------
-----------------------------**************************---------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------

CREATE TABLE HOMEPAGE.MTCONFIG (
	UUID			nvarchar(36) NOT NULL,
	SCOPE 			nvarchar(36) NOT NULL,
	ID 				nvarchar(128) NOT NULL,
	CONFIG_VALUE 	nvarchar(1024),
	SERVICE 		nvarchar(256),
	NAME	 		nvarchar(64),
	DESCRIPTION		nvarchar(64),
	OVERRIDABLE 	NUMERIC(5,0) DEFAULT 1 NOT NULL,
	ISPOLICY		NUMERIC(5,0) DEFAULT 0 NOT NULL,
	ADMIN_VIS		NUMERIC(5,0) DEFAULT 1 NOT NULL
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.MTCONFIG
	 ADD CONSTRAINT PK_ID PRIMARY KEY (UUID);
 
ALTER TABLE HOMEPAGE.MTCONFIG
	ADD CONSTRAINT UNIQUE_ID UNIQUE (SCOPE,ID);	

CREATE INDEX SETTINGS_BY_ID
    ON HOMEPAGE.MTCONFIG (ID);


-----------------------------------------------------
--  HOMEPAGE.MT_CFG_DEFINITIONS
-----------------------------------------------------
CREATE TABLE HOMEPAGE.MT_CFG_DEFINITIONS (
	DEFINITION_ID	nvarchar(36) NOT NULL,
	NAME			nvarchar(128) NOT NULL,
	TITLE			nvarchar(128),
	DESCRIPTION		nvarchar(256),
	TYPE			NVARCHAR(256),
	EDITOR			nvarchar(128),
	CAN_MODIFY		NUMERIC(5,0) DEFAULT 0 NOT NULL,
	DISPLAY			NUMERIC(5,0) DEFAULT 0 NOT NULL,
	REQUIRES		nvarchar(128),
	VALIDATOR		nvarchar(256),
	CATEGORY 		nvarchar(128),
	ALLOW_ROLE 		NUMERIC(5, 0)
)  ON [PRIMARY]
GO
    
ALTER TABLE HOMEPAGE.MT_CFG_DEFINITIONS
	ADD CONSTRAINT PK_MT_CFG_DEFINITION PRIMARY KEY (DEFINITION_ID);

CREATE UNIQUE INDEX UNQ_NAME
	ON HOMEPAGE.MT_CFG_DEFINITIONS (NAME);
	

	
-----------------------------------------------------
--  HOMEPAGE.MT_CFG_SETTINGS
-----------------------------------------------------
CREATE TABLE HOMEPAGE.MT_CFG_SETTINGS (
	SETTING_ID		nvarchar(36) NOT NULL,
	ORGANIZATION_ID	nvarchar(36) NOT NULL,
	NAME			nvarchar(128) NOT NULL,
	VALUE			NVARCHAR(256),
	CAN_MODIFY		NUMERIC(5,0) DEFAULT 0 NOT NULL,
	ROLE 			nvarchar(36)
)  ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.MT_CFG_SETTINGS
	ADD CONSTRAINT PK_MT_CFG_SETTINGS PRIMARY KEY (SETTING_ID);
	
ALTER TABLE HOMEPAGE.MT_CFG_SETTINGS 
	ADD CONSTRAINT FK_CFG_SET_ORG_ID FOREIGN KEY (ORGANIZATION_ID) 
	REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID); 	
	
CREATE UNIQUE INDEX UNQ_ORG_NAME
	ON HOMEPAGE.MT_CFG_SETTINGS (NAME, ORGANIZATION_ID, ROLE);
	
	

-----------------------------------------------------
--  HOMEPAGE.MT_CFG_FILES
-- 	TYPE: 0: BINARY FILE, 1: TXT FILE, 2: CONFIGURATION FILE
-----------------------------------------------------
CREATE TABLE HOMEPAGE.MT_CFG_FILES (
	FILE_ID			nvarchar(36) NOT NULL,
	SETTING_ID		nvarchar(36) NOT NULL,
	TYPE			NUMERIC(5,0) NOT NULL, 
	FILENAME		nvarchar(256),		
	CACHE			NUMERIC(5,0) DEFAULT 0 NOT NULL,
	C_CONTENT		NVARCHAR(MAX),
	B_CONTENT		VARBINARY(MAX),
	ORGANIZATION_ID	NVARCHAR(36) NOT NULL
)  ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.MT_CFG_FILES
	ADD CONSTRAINT PK_MT_CFG_FILE PRIMARY KEY (FILE_ID);

ALTER TABLE HOMEPAGE.MT_CFG_FILES 
	ADD CONSTRAINT FK_SETTING_ID FOREIGN KEY (SETTING_ID) REFERENCES HOMEPAGE.MT_CFG_SETTINGS (SETTING_ID);

CREATE UNIQUE INDEX UNQ_SETTING
	ON HOMEPAGE.MT_CFG_FILES (SETTING_ID);	
	
ALTER TABLE HOMEPAGE.MT_CFG_FILES 
	ADD CONSTRAINT FK_CFG_FILE_ORG_ID FOREIGN KEY (ORGANIZATION_ID) 
	REFERENCES HOMEPAGE.MT_ORGANIZATION (ORGANIZATION_ID);	

----------------------------------------------------
------------------------ END   HP FIXUP 451 -------
----------------------------------------------------
