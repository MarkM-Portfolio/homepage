-- ***************************************************************** 
--                                                                   
-- IBM Confidential                                                  
--                                                                   
-- OCO Source Materials                                              
--                                                                   
-- Copyright IBM Corp. 2017, 2017                             
--                                                                   
-- The source code for this program is not published or otherwise    
-- divested of its trade secrets, irrespective of what has been      
-- deposited with the U.S. Copyright Office.                         
--                                                                   
-- ***************************************************************** 

-- 5724_S68                                              

-- SQL Server changes DATETIME to DATETIME2(3) only

-- HOMEPAGE.PERSON

DROP INDEX PERSON_EMD_CHECK ON HOMEPAGE.PERSON;
DROP INDEX PERSON_LAST_UPDATE ON HOMEPAGE.PERSON;
DROP INDEX PERSON_SAND_LAST_UPDATE ON HOMEPAGE.PERSON;
DROP INDEX PERSON_STATE_MEM_LU_IX ON HOMEPAGE.PERSON;
DROP INDEX PERSON_SND_SR ON HOMEPAGE.PERSON;
DROP INDEX PERSON_LAST_CONN_VISIT ON HOMEPAGE.PERSON;
DROP INDEX PERSON_SAND_OPT_IDX ON HOMEPAGE.PERSON;
DROP INDEX PERSON_STATE_IDX ON HOMEPAGE.PERSON;
GO

-- remove auto generated constraint for default value (current_timestamp) on SAND_LAST_UPDATE column
declare @default_name varchar(256)
select @default_name = [name] from sys.default_constraints
where parent_object_id = object_id('HOMEPAGE.PERSON')
and col_name(parent_object_id, parent_column_id) = 'SAND_LAST_UPDATE'

exec('ALTER TABLE HOMEPAGE.PERSON DROP CONSTRAINT ' + @default_name)

ALTER TABLE HOMEPAGE.PERSON ALTER COLUMN LAST_UPDATE DATETIME2(3);
ALTER TABLE HOMEPAGE.PERSON ALTER COLUMN SAND_LAST_UPDATE DATETIME2(3);
ALTER TABLE HOMEPAGE.PERSON ALTER COLUMN CREATION_DATE DATETIME2(3);
ALTER TABLE HOMEPAGE.PERSON ALTER COLUMN LAST_CONN_VISIT DATETIME2(3);
GO

CREATE INDEX PERSON_EMD_CHECK 
	ON HOMEPAGE.PERSON (MEMBER_TYPE, CREATION_DATE ASC, STATE, USER_MAIL_LOWER, PERSON_ID, ORGANIZATION_ID);
CREATE INDEX PERSON_LAST_UPDATE
    ON HOMEPAGE.PERSON (LAST_UPDATE DESC);    
CREATE INDEX PERSON_SAND_LAST_UPDATE
    ON HOMEPAGE.PERSON (SAND_LAST_UPDATE ASC);
CREATE INDEX PERSON_STATE_MEM_LU_IX
	ON HOMEPAGE.PERSON  (STATE, MEMBER_TYPE,LAST_UPDATE);
CREATE INDEX PERSON_SND_SR 
	ON HOMEPAGE.PERSON (MEMBER_TYPE, SAND_OPT, SAND_LAST_UPDATE ASC);	
CREATE INDEX PERSON_LAST_CONN_VISIT
    ON HOMEPAGE.PERSON(LAST_CONN_VISIT DESC);	
CREATE INDEX PERSON_SAND_OPT_IDX
    ON HOMEPAGE.PERSON(SAND_OPT, SAND_LAST_UPDATE ASC)
CREATE INDEX PERSON_STATE_IDX
  ON HOMEPAGE.PERSON(MEMBER_TYPE, LAST_UPDATE ASC, STATE, PERSON_ID)
GO

-- add back constraint for default value (current_timestamp) on SAND_LAST_UPDATE column
-- but this time we name it ourselves instead of auto-generate
ALTER TABLE HOMEPAGE.PERSON
	ADD CONSTRAINT PERSON_SAND_LAST_UPDATE_DEFAULT DEFAULT (CURRENT_TIMESTAMP) FOR SAND_LAST_UPDATE;
GO

-- HP_USER_PREFS

ALTER TABLE HOMEPAGE.HP_USER_PREFS ALTER COLUMN LAST_UPDATE DATETIME2(3);
ALTER TABLE HOMEPAGE.HP_USER_PREFS ALTER COLUMN CREATE_DATE DATETIME2(3);
GO

-- HP_UI

DROP INDEX HP_UI_R ON HOMEPAGE.HP_UI;
GO

ALTER TABLE HOMEPAGE.HP_UI ALTER COLUMN LAST_VISIT DATETIME2(3) NOT NULL;
ALTER TABLE HOMEPAGE.HP_UI ALTER COLUMN LAST_NOTIFY_VISIT DATETIME2(3);
ALTER TABLE HOMEPAGE.HP_UI ALTER COLUMN LAST_ACTIONABLE_VISIT DATETIME2(3);
GO

CREATE INDEX HP_UI_R
	ON HOMEPAGE.HP_UI (LAST_VISIT);
GO

-- HP_TAB_INST

ALTER TABLE HOMEPAGE.HP_TAB_INST ALTER COLUMN LAST_MODIFIED DATETIME2(3) NOT NULL;
GO

-- HP_WIDGET_INST

ALTER TABLE HOMEPAGE.HP_WIDGET_INST ALTER COLUMN LAST_MODIFIED DATETIME2(3) NOT NULL;
ALTER TABLE HOMEPAGE.HP_WIDGET_INST ALTER COLUMN LAST_UPDATED DATETIME2(3);
GO

-- NT_REPLYTO

ALTER TABLE HOMEPAGE.NT_REPLYTO ALTER COLUMN CREATION_DATE DATETIME2(3) NOT NULL;
GO

-- NT_REPLYTO_RECIPIENT

ALTER TABLE HOMEPAGE.NT_REPLYTO_RECIPIENT ALTER COLUMN LAST_UPDATE DATETIME2(3);
GO

-- METRIC_STAT

DROP INDEX METRIC_IDX ON HOMEPAGE.METRIC_STAT;
GO

ALTER TABLE HOMEPAGE.METRIC_STAT ALTER COLUMN RECORDED_ON DATETIME2(3) NOT NULL;
GO

CREATE INDEX METRIC_IDX
    ON HOMEPAGE.METRIC_STAT (RECORDED_ON ASC, METRIC_TYPE);
GO

-- OAUTH1_TOKEN

ALTER TABLE HOMEPAGE.OAUTH1_TOKEN ALTER COLUMN EXPIRATION DATETIME2(3);
ALTER TABLE HOMEPAGE.OAUTH1_TOKEN ALTER COLUMN CREATED DATETIME2(3) NOT NULL;
ALTER TABLE HOMEPAGE.OAUTH1_TOKEN ALTER COLUMN MODIFIED DATETIME2(3) NOT NULL;
GO

-- OAUTH1_PROVIDER

ALTER TABLE HOMEPAGE.OAUTH1_PROVIDER ALTER COLUMN CREATED DATETIME2(3) NOT NULL;
ALTER TABLE HOMEPAGE.OAUTH1_PROVIDER ALTER COLUMN MODIFIED DATETIME2(3) NOT NULL;
GO

-- OAUTH1_CLIENT

ALTER TABLE HOMEPAGE.OAUTH1_CLIENT ALTER COLUMN CREATED DATETIME2(3) NOT NULL;
ALTER TABLE HOMEPAGE.OAUTH1_CLIENT ALTER COLUMN MODIFIED DATETIME2(3) NOT NULL;
GO

-- OAUTH1_CONTEXT

ALTER TABLE HOMEPAGE.OAUTH1_CONTEXT ALTER COLUMN CREATED DATETIME2(3) NOT NULL;
ALTER TABLE HOMEPAGE.OAUTH1_CONTEXT ALTER COLUMN MODIFIED DATETIME2(3) NOT NULL;
ALTER TABLE HOMEPAGE.OAUTH1_CONTEXT ALTER COLUMN EXPIRATION DATETIME2(3);
GO

-- OAUTH2_TOKEN

ALTER TABLE HOMEPAGE.OAUTH2_TOKEN ALTER COLUMN EXPIRES DATETIME2(3);
ALTER TABLE HOMEPAGE.OAUTH2_TOKEN ALTER COLUMN ISSUED DATETIME2(3) NOT NULL;
GO
