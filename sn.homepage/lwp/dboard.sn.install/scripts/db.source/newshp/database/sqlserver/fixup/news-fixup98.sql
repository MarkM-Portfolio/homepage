-- ***************************************************************** 
--                                                                   
-- IBM Confidential                                                  
--                                                                   
-- OCO Source Materials                                              
--                                                                   
-- Copyright IBM Corp. 2007, 2015                                    
--                                                                   
-- The source code for this program is not published or otherwise    
-- divested of its trade secrets, irrespective of what has been      
-- deposited with the U.S. Copyright Office.                         
--                                                                   
-- ***************************************************************** 

-- {COPYRIGHT}

-----------------------------------------------------------------
-- [START] Adding to NR_STORIES_CONTENT:
-----------------------------------------------------------------
--ITEM_CONTENT - CLOB (can be null)
--ITEM_CORRELATION_CONTENT - CLOB (can be null)

--CONTENT_FORMAT - INTEGER (can be null)
--ITEM_CONTENT_FORMAT -  INTEGER (can be null)
--ITEM_CORRELATION_FORMAT -  INTEGER (can be null)
-----------------------------------------------------------------
ALTER TABLE HOMEPAGE.NR_STORIES_CONTENT
	ADD	ITEM_CONTENT VARCHAR(MAX),	
	ITEM_CORRELATION_CONTENT VARCHAR(MAX),
	ITEM_CONTENT_FORMAT  NUMERIC(5 ,0),
	ITEM_CORRELATION_FORMAT  NUMERIC(5 ,0),
	CONTENT_FORMAT NUMERIC(5 ,0);
GO

--REORG TABLE HOMEPAGE.NR_STORIES_CONTENT;

GO
-----------------------------------------------------------------
-- [END] Adding to NR_STORIES_CONTENT:
-----------------------------------------------------------------

-- remove json
ALTER TABLE HOMEPAGE.BOARD_OBJECT_REFERENCE
	DROP COLUMN JSON_META_DATA;
	
GO

-- add
ALTER TABLE HOMEPAGE.BOARD_OBJECT_REFERENCE
	ADD OBJECT_META_DATA nvarchar(4000),
	OBJECT_META_DATA_2 nvarchar(4000),
	FULL_OBJECT_META_DATA varchar(MAX);
GO	
	
-----------------------------------------------------------------
-- [START] Adding two columns to NR_ENTRIES tables: ITEM_CORRELATION_BRIEF_DESC
-----------------------------------------------------------------
ALTER TABLE HOMEPAGE.NR_ENTRIES
	ADD	ITEM_CORRELATION_BRIEF_DESC nvarchar(4000);
GO

-----------------------------------------------------------------
-- [END] Adding two columns to NR_ENTRIES tables: ITEM_CORRELATION_BRIEF_DESC
-----------------------------------------------------------------	

-----------------------------------------------------------------
-- [START] adding back a fk from READERS table to STORIES table
-----------------------------------------------------------------

-- cleanup possible wrong records (we have seen this issue on tapstage)
--1)
DELETE FROM HOMEPAGE.NR_AGGREGATED_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_AGGREGATED_READERS.STORY_ID
				);
GO

--2)
DELETE FROM HOMEPAGE.NR_RESPONSES_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_RESPONSES_READERS.STORY_ID
				);
GO

DELETE FROM HOMEPAGE.NR_PROFILES_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_PROFILES_READERS.STORY_ID
				);
GO

--3)
DELETE FROM HOMEPAGE.NR_COMMUNITIES_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_COMMUNITIES_READERS.STORY_ID
				);
GO

--4)
DELETE FROM HOMEPAGE.NR_ACTIVITIES_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_ACTIVITIES_READERS.STORY_ID
				);
GO

--5)
DELETE FROM HOMEPAGE.NR_BLOGS_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_BLOGS_READERS.STORY_ID
				);
GO

--6)
DELETE FROM HOMEPAGE.NR_BOOKMARKS_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_BOOKMARKS_READERS.STORY_ID
				);
GO

--7)
DELETE FROM HOMEPAGE.NR_FILES_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_FILES_READERS.STORY_ID
				);
GO

--8)
DELETE FROM HOMEPAGE.NR_FORUMS_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_FORUMS_READERS.STORY_ID
				);
GO

--9)
DELETE FROM HOMEPAGE.NR_WIKIS_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_WIKIS_READERS.STORY_ID
				);
GO

--10)
DELETE FROM HOMEPAGE.NR_TAGS_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_TAGS_READERS.STORY_ID
				);
GO


--11)
DELETE FROM HOMEPAGE.NR_STATUS_UPDATE_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_STATUS_UPDATE_READERS.STORY_ID
				);
GO

--12)
DELETE FROM HOMEPAGE.NR_EXTERNAL_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_EXTERNAL_READERS.STORY_ID
				);
GO

--13)
DELETE FROM HOMEPAGE.NR_ACTIONABLE_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_ACTIONABLE_READERS.STORY_ID
				);
GO

--14)
DELETE FROM HOMEPAGE.NR_SAVED_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_SAVED_READERS.STORY_ID
				);
GO

--15)
DELETE FROM HOMEPAGE.NR_DISCOVERY_VIEW
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_DISCOVERY_VIEW.STORY_ID
				);
GO

--16)
DELETE FROM HOMEPAGE.NR_PROFILES_VIEW
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_PROFILES_VIEW.STORY_ID
				);
GO


--17)
DELETE FROM HOMEPAGE.NR_NOTIFICATION_SENT_READERS
WHERE 	NOT EXISTS (	
					SELECT 	1 
					FROM 	HOMEPAGE.NR_STORIES  STORIES
					WHERE 	STORIES.STORY_ID = NR_NOTIFICATION_SENT_READERS.STORY_ID
				);
GO

-- adding the fk
ALTER TABLE HOMEPAGE.NR_AGGREGATED_READERS 
	ADD CONSTRAINT FK_AGG_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO

ALTER TABLE HOMEPAGE.NR_RESPONSES_READERS 
	ADD CONSTRAINT FK_RES_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO

ALTER TABLE HOMEPAGE.NR_PROFILES_READERS 
	ADD CONSTRAINT FK_PRF_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO
	
ALTER TABLE HOMEPAGE.NR_COMMUNITIES_READERS
	ADD CONSTRAINT FK_COM_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO
	 
ALTER TABLE HOMEPAGE.NR_ACTIVITIES_READERS
	ADD CONSTRAINT FK_ACI_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO
	 
ALTER TABLE HOMEPAGE.NR_BLOGS_READERS
	ADD CONSTRAINT FK_BLG_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO
	 
ALTER TABLE HOMEPAGE.NR_BOOKMARKS_READERS
	ADD CONSTRAINT FK_BKM_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO
	 
ALTER TABLE HOMEPAGE.NR_FILES_READERS
	ADD CONSTRAINT FK_FIL_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO

ALTER TABLE HOMEPAGE.NR_FORUMS_READERS
	ADD CONSTRAINT FK_FRM_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO
	 
ALTER TABLE HOMEPAGE.NR_WIKIS_READERS
	ADD CONSTRAINT FK_WIK_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO

ALTER TABLE HOMEPAGE.NR_TAGS_READERS
	ADD CONSTRAINT FK_TAG_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO

ALTER TABLE HOMEPAGE.NR_STATUS_UPDATE_READERS
	ADD CONSTRAINT FK_STA_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO	
	 
ALTER TABLE HOMEPAGE.NR_EXTERNAL_READERS
	ADD CONSTRAINT FK_EXT_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO	
	
ALTER TABLE HOMEPAGE.NR_ACTIONABLE_READERS
	ADD CONSTRAINT FK_ACT_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO	
	
ALTER TABLE HOMEPAGE.NR_SAVED_READERS
	ADD CONSTRAINT FK_SAV_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO
	 
ALTER TABLE HOMEPAGE.NR_DISCOVERY_VIEW
	ADD CONSTRAINT FK_DIS_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO

ALTER TABLE HOMEPAGE.NR_PROFILES_VIEW
	ADD CONSTRAINT FK_PRO_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO
	 
ALTER TABLE HOMEPAGE.NR_NOTIFICATION_SENT_READERS
	ADD CONSTRAINT FK_NOT_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);
GO		



-----------------------------------------------------------------
-- [END] adding back a fk from READERS table to STORIES table
-----------------------------------------------------------------

-----------------------------------------------------------------
-- [START] adding cluster index on the READERS table
-----------------------------------------------------------------
ALTER TABLE HOMEPAGE.NR_AGGREGATED_READERS DROP CONSTRAINT PK_AGG_READERS;
ALTER TABLE HOMEPAGE.NR_RESPONSES_READERS DROP CONSTRAINT PK_RESP_READERS;
ALTER TABLE HOMEPAGE.NR_PROFILES_READERS DROP CONSTRAINT PK_PROF_READERS;
ALTER TABLE HOMEPAGE.NR_COMMUNITIES_READERS DROP CONSTRAINT PK_COMM_READERS;
ALTER TABLE HOMEPAGE.NR_ACTIVITIES_READERS DROP CONSTRAINT PK_ACT_READERS;
ALTER TABLE HOMEPAGE.NR_BLOGS_READERS DROP CONSTRAINT PK_BLOGS_READERS;
ALTER TABLE HOMEPAGE.NR_BOOKMARKS_READERS DROP CONSTRAINT  PK_BOOKS_READERS;
ALTER TABLE HOMEPAGE.NR_FILES_READERS DROP CONSTRAINT PK_FILES_READERS;
ALTER TABLE HOMEPAGE.NR_FORUMS_READERS DROP CONSTRAINT PK_FORUMS_READERS;
ALTER TABLE HOMEPAGE.NR_WIKIS_READERS DROP CONSTRAINT PK_WIKIS_READERS;
ALTER TABLE HOMEPAGE.NR_TAGS_READERS DROP CONSTRAINT PK_TAGS_READERS;
ALTER TABLE HOMEPAGE.NR_STATUS_UPDATE_READERS DROP CONSTRAINT  PK_SU_READERS;
ALTER TABLE HOMEPAGE.NR_EXTERNAL_READERS DROP CONSTRAINT  PK_EXT_READERS;
ALTER TABLE HOMEPAGE.NR_ACTIONABLE_READERS DROP CONSTRAINT PK_ACTION_READERS;
ALTER TABLE HOMEPAGE.NR_SAVED_READERS DROP CONSTRAINT PK_SAVED_READERS;
ALTER TABLE HOMEPAGE.NR_DISCOVERY_VIEW DROP CONSTRAINT  PK_DISCOVERY_VIEW;
ALTER TABLE HOMEPAGE.NR_PROFILES_VIEW DROP CONSTRAINT PK_PROFILES_VIEW;
ALTER TABLE HOMEPAGE.NR_NOTIFICATION_SENT_READERS DROP CONSTRAINT  PK_SENT_NOT_READ;

GO

CREATE CLUSTERED INDEX CL_AGGREGATED_READERS_IDX
	ON HOMEPAGE.NR_AGGREGATED_READERS (READER_ID);
GO

CREATE CLUSTERED INDEX CL_RESPONSES_READERS_IDX
	ON HOMEPAGE.NR_RESPONSES_READERS (READER_ID);
GO	

CREATE CLUSTERED INDEX CL_PROFILES_READERS_IDX
	ON HOMEPAGE.NR_PROFILES_READERS (READER_ID);
GO
	
CREATE CLUSTERED INDEX CL_COMM_READERS_IDX
	ON HOMEPAGE.NR_COMMUNITIES_READERS (READER_ID);
GO
	 
CREATE CLUSTERED INDEX CL_ACTIVITIES_READERS_IDX
	ON HOMEPAGE.NR_ACTIVITIES_READERS (READER_ID);
GO
	 
CREATE CLUSTERED INDEX CL_BLOGS_READERS_IDX
	ON HOMEPAGE.NR_BLOGS_READERS (READER_ID);
GO
	 
CREATE CLUSTERED INDEX CL_BOOKMARKS_READERS_IDX
	ON HOMEPAGE.NR_BOOKMARKS_READERS (READER_ID);
GO
	 
CREATE CLUSTERED INDEX CL_FILES_READERS_IDX
	ON HOMEPAGE.NR_FILES_READERS (READER_ID);
GO

CREATE CLUSTERED INDEX CL_FORUMS_READERS_IDX
	ON HOMEPAGE.NR_FORUMS_READERS (READER_ID);
GO
	 
CREATE CLUSTERED INDEX CL_WIKIS_READERS_IDX
	ON HOMEPAGE.NR_WIKIS_READERS (READER_ID);
GO

CREATE CLUSTERED INDEX CL_TAGS_READERS_IDX
	ON HOMEPAGE.NR_TAGS_READERS (READER_ID);
GO

CREATE CLUSTERED INDEX CL_STATUS_READERS_IDX
	ON HOMEPAGE.NR_STATUS_UPDATE_READERS  (READER_ID);
GO	
	 
CREATE CLUSTERED INDEX CL_EXTERNAL_READERS_IDX
	ON HOMEPAGE.NR_EXTERNAL_READERS  (READER_ID);
GO	
	
CREATE CLUSTERED INDEX CL_ACTIONABLE_READERS_IDX
	ON HOMEPAGE.NR_ACTIONABLE_READERS  (READER_ID);
GO	
	
CREATE CLUSTERED INDEX CL_SAVED_READERS_IDX
	ON HOMEPAGE.NR_SAVED_READERS  (READER_ID);
GO
	 
CREATE CLUSTERED INDEX CL_DISCOVERY_READERS_IDX
	ON HOMEPAGE.NR_DISCOVERY_VIEW  (READER_ID);
GO

CREATE CLUSTERED INDEX CL_PROFILESV_READERS_IDX
	ON HOMEPAGE.NR_PROFILES_VIEW  (READER_ID);
GO
	 
CREATE CLUSTERED INDEX CL_NOTIFICA_READERS_IDX
	ON HOMEPAGE.NR_NOTIFICATION_SENT_READERS  (READER_ID);
GO

ALTER TABLE HOMEPAGE.NR_AGGREGATED_READERS
    ADD CONSTRAINT PK_AGG_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_RESPONSES_READERS 
    ADD CONSTRAINT PK_RESP_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_PROFILES_READERS 
    ADD CONSTRAINT PK_PROF_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_COMMUNITIES_READERS 
    ADD CONSTRAINT PK_COMM_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_ACTIVITIES_READERS 
    ADD CONSTRAINT PK_ACT_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_BLOGS_READERS 
    ADD CONSTRAINT PK_BLOGS_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_BOOKMARKS_READERS 
    ADD CONSTRAINT PK_BOOKS_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_FILES_READERS 
    ADD CONSTRAINT PK_FILES_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_FORUMS_READERS 
    ADD CONSTRAINT PK_FORUMS_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_WIKIS_READERS 
    ADD CONSTRAINT PK_WIKIS_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_TAGS_READERS 
    ADD CONSTRAINT PK_TAGS_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_STATUS_UPDATE_READERS 
    ADD CONSTRAINT PK_SU_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_EXTERNAL_READERS 
    ADD CONSTRAINT PK_EXT_READERS PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_ACTIONABLE_READERS 
    ADD CONSTRAINT PK_ACTION_READERS PRIMARY KEY (CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_DISCOVERY_VIEW 
    ADD CONSTRAINT PK_DISCOVERY_VIEW PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_PROFILES_VIEW 
    ADD CONSTRAINT PK_PROFILES_VIEW PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_NOTIFICATION_SENT_READERS 
    ADD CONSTRAINT PK_SENT_NOT_READ PRIMARY KEY(CATEGORY_READER_ID);

ALTER TABLE HOMEPAGE.NR_SAVED_READERS 
    ADD CONSTRAINT PK_SAVED_READERS PRIMARY KEY (CATEGORY_READER_ID);
GO

-----------------------------------------------------------------
-- [STOP] adding cluster index on the READERS table
-----------------------------------------------------------------

-----------------------------------------------------------------
-- [START] N_COMMENTS AND N_RECOMMENDATIONS need to be nullable
-----------------------------------------------------------------

DECLARE @CONST_NAME as nvarchar(128), @DROP_STMT as nvarchar(2000)
SET @CONST_NAME = (select name from sys.default_constraints where parent_object_id=OBJECT_ID('HOMEPAGE.NR_ENTRIES') and name like '%DF__NR_ENTRIE_N_COM%')
SET @DROP_STMT = N'ALTER TABLE HOMEPAGE.NR_ENTRIES DROP CONSTRAINT ' + @CONST_NAME
EXEC (@DROP_STMT)
GO

ALTER TABLE HOMEPAGE.NR_ENTRIES ALTER COLUMN N_COMMENTS NUMERIC(5,0);
GO
UPDATE HOMEPAGE.NR_ENTRIES SET N_COMMENTS = NULL WHERE N_COMMENTS = -1;
GO

DECLARE @CONST_NAME as nvarchar(128), @DROP_STMT as nvarchar(2000)
SET @CONST_NAME = (select name from sys.default_constraints where parent_object_id=OBJECT_ID('HOMEPAGE.NR_ENTRIES') and name like '%DF__NR_ENTRIE_N_REC%')
SET @DROP_STMT = N'ALTER TABLE HOMEPAGE.NR_ENTRIES DROP CONSTRAINT ' + @CONST_NAME
EXEC (@DROP_STMT)
GO

ALTER TABLE HOMEPAGE.NR_ENTRIES ALTER COLUMN N_RECOMMANDATIONS NUMERIC(5,0);
GO
UPDATE HOMEPAGE.NR_ENTRIES SET N_RECOMMANDATIONS = NULL WHERE N_RECOMMANDATIONS = -1;
GO
-----------------------------------------------------------------
-- [END] N_COMMENTS AND N_RECOMMENDATIONS need to be nullable
-----------------------------------------------------------------

--- Adding EVENT_SCOPE
ALTER TABLE HOMEPAGE.NR_STORIES
	ADD EVENT_SCOPE NUMERIC(5,0);
GO	
	
	
------------------------------------------------------------------
-- [START] Adding calendar templates
------------------------------------------------------------------
INSERT INTO HOMEPAGE.NR_TEMPLATE
		(TEMPLATE_ID, NAME, DATA_SOURCE_STRING, FORMAT, NO_VALUES)
VALUES	('general-containerffasfh3452yst42465','container','containerName;containerHtmlPath', 'link', 1);

INSERT INTO HOMEPAGE.NR_TEMPLATE
		(TEMPLATE_ID, NAME, DATA_SOURCE_STRING, FORMAT, NO_VALUES)
VALUES	('general-item-slkmg9015bxBNKbkHkdf65','item','itemName;itemHtmlPath', 'link', 1);

INSERT INTO HOMEPAGE.NR_TEMPLATE
		(TEMPLATE_ID, NAME, DATA_SOURCE_STRING, FORMAT, NO_VALUES)
VALUES	('general-correllation-asdfbe898Bjr95','correlationitem','correlationName;correlationHtmlPath', 'link', 1);

------------------------------------------------------------------
-- [END] Adding calendar templates
------------------------------------------------------------------

------------------------------------------------------------------
-- Adding NR_ENTRIES_ARCHIVE table
------------------------------------------------------------------
----------------------------------------------------------------
-- HOMEPAGE.NR_ENTRIES_ARCHIVE
----------------------------------------------------------------
CREATE TABLE HOMEPAGE.NR_ENTRIES_ARCHIVE (
	ENTRY_ID nvarchar(36) NOT NULL,
	SOURCE nvarchar(36) NOT NULL,
	SOURCE_TYPE NUMERIC(5,0),
	CONTAINER_ID nvarchar(256),
	CONTAINER_NAME nvarchar(256),
	CONTAINER_URL nvarchar(2048),
	ITEM_ID nvarchar(36),
	ITEM_NAME nvarchar(256),
	ITEM_URL nvarchar(2048),
	ITEM_CREATION_DATE DATETIME NOT NULL,
	ITEM_UPDATE_DATE DATETIME NOT NULL,
	ITEM_TAGS nvarchar(1024),
	N_COMMENTS NUMERIC(5,0) DEFAULT NULL,
	N_RECOMMANDATIONS NUMERIC(5,0) DEFAULT NULL,
	LAST_COMMENT_ID nvarchar(36),
	LAST_DATE_COMMENT DATETIME,
	LAST_AUTHOR_COMMENT nvarchar(36),
	PREV_COMMENT_ID nvarchar(36),
	PREV_DATE_COMMENT DATETIME,
	PREV_AUTHOR_COMMENT nvarchar(36),
	TARGET_SUBJECT_ID nvarchar(36),
	ITEM_ATOM_URL nvarchar(2048),
	PREVIEW_IMAGE_URL nvarchar(2048),
	JSON_META_DATA nvarchar(4000),
	ITEM_SCOPE NUMERIC(5,0),
	IS_LAST_COMMENT_PUBLIC NUMERIC(5,0),
	IS_PREV_COMMENT_PUBLIC NUMERIC(5,0),
	ITEM_CORRELATION_ID nvarchar(36),
	ITEM_CORRELATION_NAME nvarchar(256),
	LAST_DESC_COMMENT nvarchar(4000),
	PREV_DESC_COMMENT nvarchar(4000),
	LAST_UPDATE_DATE_COMMENT DATETIME, 
	PREV_UPDATE_DATE_COMMENT DATETIME,
	ITEM_AUTHOR_UUID nvarchar (36),
	ITEM_AUTHOR_DISPLAYNAME nvarchar (256),
	ITEM_CORRELATION_AUTHOR_UUID nvarchar (36),
	ITEM_CORRELATION_AUTHOR_NAME nvarchar (256),
	BRIEF_DESC nvarchar (4000),
	ITEM_CORRELATION_BRIEF_DESC nvarchar (4000)
) ON [PRIMARY]
GO

ALTER TABLE HOMEPAGE.NR_ENTRIES_ARCHIVE
    ADD CONSTRAINT PK_ENTRY_AR_ID PRIMARY KEY(ENTRY_ID);

CREATE INDEX NR_ENTRIES_AR_CONT
    ON HOMEPAGE.NR_ENTRIES_ARCHIVE (CONTAINER_ID);

CREATE UNIQUE INDEX NR_ENTRIES_AR_ITEM
    ON HOMEPAGE.NR_ENTRIES_ARCHIVE (ITEM_ID);

GO

--------------------------------------------------------------------------
-- 20 HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS
--------------------------------------------------------------------------
CREATE TABLE HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS (
CATEGORY_READER_ID nvarchar(36)  DEFAULT ' ' NOT NULL,
	READER_ID nvarchar(36) NOT NULL,
	CATEGORY_TYPE NUMERIC(5,0) NOT NULL,
	SOURCE nvarchar(36) NOT NULL,
	CONTAINER_ID nvarchar(256),
	ITEM_ID nvarchar(36),
	ROLLUP_ENTRY_ID nvarchar(36),
	RESOURCE_TYPE NUMERIC(5,0) NOT NULL,
	CREATION_DATE DATETIME NOT NULL,
	STORY_ID nvarchar(36) NOT NULL,
	SOURCE_TYPE NUMERIC(5,0),
	USE_IN_ROLLUP NUMERIC(5,0),
	IS_NETWORK	NUMERIC(5,0),
	IS_FOLLOWER	NUMERIC(5,0),
	EVENT_TIME 	DATETIME,
	IS_STORY_COMM NUMERIC(5 ,0),
	IS_BROADCAST NUMERIC(5,0),
	ORGANIZATION_ID nvarchar(36),
	ACTOR_UUID nvarchar(36),
        CONSTRAINT   	CK_CAT20_TYPE
    			CHECK
    			(CATEGORY_TYPE = 20)
) ON [PRIMARY]
GO

CREATE CLUSTERED INDEX CL_REC_READERS_IDX
	ON HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS (READER_ID);
GO

ALTER TABLE HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS 
    ADD CONSTRAINT PK_REC_NOT_READ PRIMARY KEY(CATEGORY_READER_ID);
    
ALTER TABLE HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS
	ADD CONSTRAINT FK_REC_READERS_STR FOREIGN KEY (STORY_ID)
	REFERENCES HOMEPAGE.NR_STORIES (STORY_ID);    

CREATE  INDEX REC_READERS_STR_IX 
 	ON HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS (STORY_ID); 
GO

CREATE  INDEX REC_READERS_ITM_IX 
 	ON HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS (ITEM_ID); 
GO

CREATE  INDEX REC_READERS_CD_IX 
 	ON HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS (STORY_ID, CREATION_DATE DESC); 
GO

CREATE  INDEX REC_READERS_SRC_IX 
 	ON HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS (READER_ID, CREATION_DATE DESC, STORY_ID, IS_BROADCAST, ROLLUP_ENTRY_ID, SOURCE_TYPE); 
GO

CREATE  INDEX REC_READERS_ACT_IX 
 	ON HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS (READER_ID, CREATION_DATE DESC, ACTOR_UUID, STORY_ID, IS_BROADCAST, ROLLUP_ENTRY_ID, SOURCE_TYPE); 
GO

CREATE  INDEX REC_READERS_RLL_IX 
 	ON HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS (USE_IN_ROLLUP, READER_ID, CREATION_DATE DESC, STORY_ID, IS_BROADCAST, ROLLUP_ENTRY_ID, SOURCE_TYPE); 
GO

CREATE UNIQUE INDEX REC_READERS_UNQ_RDR_STR 
 	ON HOMEPAGE.NR_NOTIFICATION_RECEIV_READERS (READER_ID, STORY_ID); 
GO

------------------------------------
-- Adding the category type for: notification-received
------------------------------------
INSERT INTO HOMEPAGE.NR_CATEGORY_TYPE (CATEGORY_TYPE_ID, CATEGORY_TYPE, CATEGORY_TYPE_NAME, CATEGORY_TYPE_DESC)
VALUES ('notification-received', 20, '%notification-received', 'notification-received');

------------------------------------------------------------------
-- [START] Adding GENERAL templates (for EXTERNAL events)
------------------------------------------------------------------
INSERT INTO HOMEPAGE.NR_TEMPLATE
		(TEMPLATE_ID, NAME, DATA_SOURCE_STRING, FORMAT, NO_VALUES)
VALUES	('Actor-3913FB2B6B5D4323BFD4DAAC189B8','Actor', 'actorInternalId', 'profilePhoto', 1); 

INSERT INTO HOMEPAGE.NR_TEMPLATE
		(TEMPLATE_ID, NAME, DATA_SOURCE_STRING, FORMAT, NO_VALUES)
VALUES	('Object-CEDEBA0964F2442EB3E5155493C0','Object', 'asObjectType;asObjectInternalId;asObjectName;asObjectHtmlPath', 'activityObject', 1);

INSERT INTO HOMEPAGE.NR_TEMPLATE
		(TEMPLATE_ID, NAME, DATA_SOURCE_STRING, FORMAT, NO_VALUES)
VALUES	('Target-5EF5EDF61F9F47F692ED1CDFDF86','Target', 'asTargetType;asTargetInternalId;asTargetName;asTargetHtmlPath', 'activityObject', 1);

------------------------------------------------------------------
-- [END] Adding GENERAL templates (for EXTERNAL events)
------------------------------------------------------------------
