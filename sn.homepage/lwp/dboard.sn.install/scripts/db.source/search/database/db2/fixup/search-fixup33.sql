-- ***************************************************************** 
--                                                                   
-- IBM Confidential                                                  
--                                                                   
-- OCO Source Materials                                              
--                                                                   
-- Copyright IBM Corp. 2007, 2015                                    
--                                                                   
-- The source code for this program is not published or otherwise    
-- divested of its trade secrets, irrespective of what has been      
-- deposited with the U.S. Copyright Office.                         
--                                                                   
-- ***************************************************************** 

-- {COPYRIGHT}

---------------------------------------------------------------------------------
------------------------ START SEARCH -------------------------------------------
---------------------------------------------------------------------------------


----------------------------------------
--  SR_INDEXINGTASKDEF
----------------------------------------

UPDATE HOMEPAGE.SR_INDEXINGTASKDEF SET INDEXING_TASK_SERVICES=LOWER(INDEXING_TASK_SERVICES);

UPDATE HOMEPAGE.SR_INDEXINGTASKDEF SET INDEXING_TASK_SERVICES='all_configured' 
WHERE INDEXING_TASK_ID='315a416c-78e2-4cf4-bcb2-69eb8d3a2583';

UPDATE  HOMEPAGE.SR_INDEXINGTASKDEF SET INDEXING_TASK_SERVICES=INDEXING_TASK_SERVICES || '-forums'
WHERE   INDEXING_TASK_SERVICES LIKE '%communities%' AND INDEXING_TASK_SERVICES NOT LIKE '%forums%';

----------------------------------------
--  SR_RESUME_TOKENS
----------------------------------------


CREATE TABLE HOMEPAGE.TMP_SR_RESUME_TOKENS(
	TOKEN_ID VARCHAR(36) NOT NULL,
	NODE_ID VARCHAR(36) NOT NULL,
	TOKEN VARCHAR(256),
	SERVICE VARCHAR(36) NOT NULL
)
IN HOMEPAGETABSPACE;

INSERT INTO HOMEPAGE.TMP_SR_RESUME_TOKENS(
	SELECT TOKEN_ID,NODE_ID,TOKEN,SERVICE FROM HOMEPAGE.SR_RESUME_TOKENS
);

ALTER TABLE HOMEPAGE.SR_RESUME_TOKENS 
DROP COLUMN TOKEN;

ALTER TABLE HOMEPAGE.SR_RESUME_TOKENS 
ADD COLUMN TOKEN VARCHAR(256);

reorg table HOMEPAGE.SR_RESUME_TOKENS use TEMPSPACE1;
reorg indexes all for table HOMEPAGE.SR_RESUME_TOKENS;

RUNSTATS ON TABLE "HOMEPAGE"."SR_RESUME_TOKENS";
RUNSTATS ON TABLE "HOMEPAGE"."SR_RESUME_TOKENS" FOR INDEXES ALL;

UPDATE HOMEPAGE.SR_RESUME_TOKENS 
SET TOKEN=( SELECT TMP.TOKEN 
			 FROM HOMEPAGE.TMP_SR_RESUME_TOKENS TMP
			 WHERE  TMP.TOKEN_ID=HOMEPAGE.SR_RESUME_TOKENS.TOKEN_ID
			);

DROP TABLE HOMEPAGE.TMP_SR_RESUME_TOKENS;

----------------------------------------
--  SR_FEEDBACK
----------------------------------------

CREATE TABLE HOMEPAGE.SR_FEEDBACK (
	ID VARCHAR(36) NOT NULL,
	PERSON_ID  VARCHAR(36) NOT NULL,
	CLIENT_ID VARCHAR(256) NOT NULL,
	ACTION VARCHAR(256) NOT NULL,
	FEEDBACK_TIME	TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	ITEM_ID  VARCHAR(256) NOT NULL 
)
IN HOMEPAGETABSPACE;

ALTER TABLE HOMEPAGE.SR_FEEDBACK
	ADD CONSTRAINT "PK_FEEDBACK_ID" PRIMARY KEY ("ID");	
	
ALTER TABLE HOMEPAGE.SR_FEEDBACK
	ADD CONSTRAINT "FK_SRFB_PERSON_ID" FOREIGN KEY ("PERSON_ID")
	REFERENCES HOMEPAGE.PERSON("PERSON_ID");
	
CREATE INDEX HOMEPAGE.SR_FEEDBACK_CLIENT_IDX
		ON HOMEPAGE.SR_FEEDBACK (CLIENT_ID);

RUNSTATS ON TABLE "HOMEPAGE"."SR_FEEDBACK";
RUNSTATS ON TABLE "HOMEPAGE"."SR_FEEDBACK" FOR INDEXES ALL;

{DB2_GRANT_START} HOMEPAGE.SR_FEEDBACK {DB2_GRANT_STOP}


----------------------------------------
--  SR_FEEDBACK_CONTEXT
----------------------------------------

CREATE TABLE HOMEPAGE.SR_FEEDBACK_CONTEXT (
	CONTEXT_ID VARCHAR(36) NOT NULL,
	ID VARCHAR(36) NOT NULL,
	TYPE  VARCHAR(256) NOT NULL,
	TYPE_VALUE VARCHAR(256) NOT NULL,
	WEIGHT VARCHAR(256) NOT NULL
)
IN HOMEPAGETABSPACE;


ALTER TABLE HOMEPAGE.SR_FEEDBACK_CONTEXT
	ADD CONSTRAINT "PK_FBK_CTXT_ID" PRIMARY KEY ("CONTEXT_ID");	

ALTER TABLE HOMEPAGE.SR_FEEDBACK_CONTEXT
	ADD CONSTRAINT "FK_FBK_CTXT_ID" FOREIGN KEY ("ID")
	REFERENCES HOMEPAGE.SR_FEEDBACK("ID") ON DELETE CASCADE;

RUNSTATS ON TABLE "HOMEPAGE"."SR_FEEDBACK_CONTEXT";
RUNSTATS ON TABLE "HOMEPAGE"."SR_FEEDBACK_CONTEXT" FOR INDEXES ALL;

{DB2_GRANT_START} HOMEPAGE.SR_FEEDBACK_CONTEXT {DB2_GRANT_STOP}

----------------------------------------
--  SR_FEEDBACK_PARAMETERS
----------------------------------------

CREATE TABLE HOMEPAGE.SR_FEEDBACK_PARAMETERS (
	PARAMETERS_ID VARCHAR(36) NOT NULL,
	ID VARCHAR(36) NOT NULL,
	PARAM  VARCHAR(256) NOT NULL,
	PARAM_VALUE VARCHAR(256) NOT NULL
)
IN HOMEPAGETABSPACE;
	
ALTER TABLE HOMEPAGE.SR_FEEDBACK_PARAMETERS
	ADD CONSTRAINT "PK_FBK_PARAMS_ID" PRIMARY KEY ("PARAMETERS_ID");
	
ALTER TABLE HOMEPAGE.SR_FEEDBACK_PARAMETERS
	ADD CONSTRAINT "FK_FBK_PARAMS_ID" FOREIGN KEY ("ID")
	REFERENCES HOMEPAGE.SR_FEEDBACK("ID") ON DELETE CASCADE;

RUNSTATS ON TABLE "HOMEPAGE"."SR_FEEDBACK_PARAMETERS";
RUNSTATS ON TABLE "HOMEPAGE"."SR_FEEDBACK_PARAMETERS" FOR INDEXES ALL;

{DB2_GRANT_START} HOMEPAGE.SR_FEEDBACK_PARAMETERS {DB2_GRANT_STOP}

----------------------------------------
--  SR_STATS
----------------------------------------

CREATE TABLE HOMEPAGE.SR_STATS(
	STAT_ID		VARCHAR(36) NOT NULL,
	STAT_KEY 	VARCHAR(256) NOT NULL,
	STAT_TYPE	SMALLINT NOT NULL,
	UPDATED		TIMESTAMP NOT NULL
)
IN HOMEPAGETABSPACE;

ALTER TABLE HOMEPAGE.SR_STATS
	ADD CONSTRAINT "PK_SR_STAT_ID" PRIMARY KEY ("STAT_ID");

ALTER TABLE HOMEPAGE.SR_STATS
	ADD CONSTRAINT "UNIQUE_STAT_KEY" UNIQUE ("STAT_KEY");


RUNSTATS ON TABLE "HOMEPAGE"."SR_STATS";
RUNSTATS ON TABLE "HOMEPAGE"."SR_STATS" FOR INDEXES ALL;

{DB2_GRANT_START} HOMEPAGE.SR_STATS {DB2_GRANT_STOP}

----------------------------------------
--  SR_STRING_STATS
----------------------------------------

CREATE TABLE HOMEPAGE.SR_STRING_STATS(
	STRING_STAT_ID		VARCHAR(36) NOT NULL,
	STAT_ID				VARCHAR(36) NOT NULL,
	STAT_VALUE			VARCHAR(256)  NOT NULL
)
IN HOMEPAGETABSPACE;

ALTER TABLE HOMEPAGE.SR_STRING_STATS
	ADD CONSTRAINT "PK_STR_STAT_ID" PRIMARY KEY ("STRING_STAT_ID");

ALTER TABLE HOMEPAGE.SR_STRING_STATS
	ADD CONSTRAINT "FK_STR_STAT_ID" FOREIGN KEY ("STAT_ID")
	REFERENCES HOMEPAGE.SR_STATS("STAT_ID") ON DELETE CASCADE;

RUNSTATS ON TABLE "HOMEPAGE"."SR_STRING_STATS";
RUNSTATS ON TABLE "HOMEPAGE"."SR_STRING_STATS" FOR INDEXES ALL;

{DB2_GRANT_START} HOMEPAGE.SR_STRING_STATS {DB2_GRANT_STOP}

----------------------------------------
--  SR_NUMBER_STATS
----------------------------------------

CREATE TABLE HOMEPAGE.SR_NUMBER_STATS(
	NUMBER_STAT_ID		VARCHAR(36) NOT NULL,
	STAT_ID				VARCHAR(36) NOT NULL,
	STAT_VALUE			BIGINT NOT NULL
)
IN HOMEPAGETABSPACE;

ALTER TABLE HOMEPAGE.SR_NUMBER_STATS
	ADD CONSTRAINT "PK_NUM_STAT_ID" PRIMARY KEY ("NUMBER_STAT_ID");


ALTER TABLE HOMEPAGE.SR_NUMBER_STATS
	ADD CONSTRAINT "FK_NUM_STAT_ID" FOREIGN KEY ("STAT_ID")
	REFERENCES HOMEPAGE.SR_STATS("STAT_ID") ON DELETE CASCADE;

RUNSTATS ON TABLE "HOMEPAGE"."SR_NUMBER_STATS";
RUNSTATS ON TABLE "HOMEPAGE"."SR_NUMBER_STATS" FOR INDEXES ALL;
	
{DB2_GRANT_START} HOMEPAGE.SR_NUMBER_STATS {DB2_GRANT_STOP}


----------------------------------------
--  SR_TIMER_STATS
----------------------------------------

CREATE TABLE HOMEPAGE.SR_TIMER_STATS(
	TIMER_STAT_ID		VARCHAR(36) NOT NULL,
	STAT_ID				VARCHAR(36) NOT NULL,
	AVERAGE				BIGINT NOT NULL,
	MINIMUM				BIGINT NOT NULL,
	MAXIMUM				BIGINT NOT NULL,
	COUNTER				INTEGER	NOT NULL
)
IN HOMEPAGETABSPACE;

ALTER TABLE HOMEPAGE.SR_TIMER_STATS
	ADD CONSTRAINT "PK_TMR_STAT_ID" PRIMARY KEY ("TIMER_STAT_ID");	
	
ALTER TABLE HOMEPAGE.SR_TIMER_STATS
	ADD CONSTRAINT "FK_TMR_STAT_ID" FOREIGN KEY ("STAT_ID")
	REFERENCES HOMEPAGE.SR_STATS("STAT_ID") ON DELETE CASCADE;

RUNSTATS ON TABLE "HOMEPAGE"."SR_TIMER_STATS";
RUNSTATS ON TABLE "HOMEPAGE"."SR_TIMER_STATS" FOR INDEXES ALL;

{DB2_GRANT_START} HOMEPAGE.SR_TIMER_STATS {DB2_GRANT_STOP}
	
---------------------------------------------------------------------------------
------------------------ END SEARCH ---------------------------------------------
---------------------------------------------------------------------------------